<!DOCTYPE html>
<html>
<head>
	<title>Gloopy</title>
	<meta charset="utf-8">
	<style>html,body{margin:0px;padding:0px;height:100%} #gloopy{height:100%} #gloopy a{color:#fff} #gloopy .fs{width:100%;height:100%;top:0px;left:0px;position:absolute;display:block} #gloopy #controls{font-family:sans-serif;background-color:#123;color:#eee;text-align:center;width:22em;left:25%;padding:0px 2em;overflow:auto} #gloopy #controls button{font-size:x-large}</style>
</head>
<body>
<div id="gloopy">
	<canvas id="back" class="fs"></canvas>
	<canvas id="front" class="fs"></canvas>
	<div id="controls" class="fs"><h1>Gloopy</h1>
		<fieldset><legend>Controls</legend><table style="width: 100%;"><tr><td>Up Arrow / W</td><td>Forward</td></tr><tr><td>Down Arrow / S</td><td>Backwards</td></tr><tr><td>Left Arrow / Q</td><td>Turn Left</td></tr><tr><td>Right Arrow / E</td><td>Turn Right</td></tr><tr><td>A</td><td>Strafe Left</td></tr><tr><td>D</td><td>Strafe Right</td></tr></table></fieldset>
		<fieldset><legend>Map</legend><div id="mapPreviews"></div></fieldset>
		<fieldset><legend>Options</legend><label><input id="numCPUs" type="number" value="5" style="width: 3em;">Opponents (1-13)</label><br /><label><input id="startPoints" type="number" value="10" style="width: 3em;">Starting points (1-20)</label><br /><label><input id="fastRaycast" type="checkbox" checked="checked">Use fast raycaster</label></fieldset>
		<button id="startGame">Start Game</button>
	</div>
</div>
<script type="text/javascript">(function(e,n){function d(e,t,n){for(var r=0,i=e[f];r<i;++r)t.call(n||this,e[r],r,e)}function v(e,t,n){for(var r=0,i=e[f];r<i;++r)if(e[r][t]===n)return e[r]}function m(e){return function(e){return e(e)}(function(t){return function(){return e(t(t)).apply(null,arguments)}})}function g(e){return e*Math.PI/180}function y(e){return e/Math.PI/180}function b(e){return e<0?-e:e}function w(e,t){return e>t?e:t}function E(e,t){return e<t?e:t}function S(e,t,n){return w(E(e,t||0),n||0)}function T(e){return e*e}function O(e,t,n,r){return N(T(n-e)+T(r-t))}function M(){return}function _(e){return n.getElementById(e)}function F(e){var t={},n=[],r=e||Infinity;return function(e,i){return i?(t[e]=i,n.push(i),n[f]>r&&delete t[n.shift()],i):t[e]}}function U(e,t,n,r){return this.constructor==U?(this.r=e,this.g=t,this.b=n,this.a=r!==M()?r:1,this):new U(e,t,n,r)}function W(e){var t=D("canvas");t.width=t.height=r,t.style.width=t.style.height="50px",t.style.margin="3px";var n=t.getContext("2d");n.fillStyle="#FFFFFF",n.fillRect(0,0,r,r);var i={rect:function(e,t,r,i){n.fillStyle="#000000";for(var s=e|0;s<e+r;s++)for(var o=t|0;o<t+i;o++)n.fillRect(s,o,1,1)}};return e(i,r),t}function V(e){function y(e,n){v.push(this),this.points=[],this.clr=e,this.s=0,this.l=0,this.t=0,this.v=-B/2;var i=l,s=l/2;do this.x=i+P()*(r-30),this.y=i+P()*(r-30);while(h.get(this.x,this.y)!==M()||h.get(this.x+s,this.y+s)!==M()||h.get(this.x+s,this.y-s)!==M()||h.get(this.x-s,this.y+s)!==M()||h.get(this.x-s,this.y-s)!==M());h.rect(this.x-s,this.y-s,i,i,e,this),this.points=H(this.points),this.points.transfer=function(e,t,n){for(var r=0,i=this[f];r<i;r++){var s=this[r];if(s.x==e&&s.y==t){s.c.player=n,n.points.push(this.splice(r,1)[0]);break}}},this.tick=function(){var e=(new Date).getTime();return function(r){n.call(this),t=(r-e)/40,e=r,this.playerMove(t),this.pointMove(t)}}()}function D(){var e=[];d(v,function(t){t.points[f]>0&&e.push(t)}),e[f]===1&&(e[0]===b?alert("Yay! You won!"):alert("Oh noes! You lost."),z())}function z(){F=!1,X.style.display="block";var e;while(e=a.pop())clearInterval(e)}e=e||{},e.numCPUs=e.numCPUs||2,e.fastRaycast=e.fastRaycast!==M()?e.fastRaycast:!0,e.map=e.map||p;var n=function(){var e=_("back");return e.width=R().width/1.5,e.height=1,e.getContext("2d")}(),s=function(){var e=_("front"),t=R().width/R().height;return e.width=100*t,e.height=100,e.getContext("2d")}(),h=function(){function a(e,t,n,r,s,o){s=s||null;for(var u=e|0;u<e+n;u++)for(var a=t|0;a<t+r;a++)s&&o&&(s=s.clone(),s.player=o,o.points.push({x:u,y:a,c:s})),i[u][a]=s}var t=r-1,n=r-1,i=[];for(var s=0;s<=t;s++){var o=[];i.push(o);for(var u=0;u<=n;u++)s==0||s==t||u==0||u==n?o.push(null):o.push(undefined)}var l=function(){function e(e,t,n,i,s){var o=i?1:-1,u=o*n,a=i?Math.ceil(e):e|0,f=t+(a-e)*n,l=[];l.dist=Infinity;while(a>=0&&a<r&&f>=0&&f<r){var c=s[a+(i?0:-1)|0][f|0];if(c===null){l.dist=O(e,t,a,f);break}l.push({x:a,y:f,r:c}),a+=o,f+=u}return l}function t(e,t,n,i,s){var o=i?-1:1,u=o*n,a=i?t|0:Math.ceil(t),f=e+(a-t)*n,l=[];l.dist=Infinity;while(f>=0&&f<r&&a>=0&&a<r){var c=s[f|0][a+(i?-1:0)|0];if(c===null){l.dist=O(e,t,f,a);break}l.push({x:f,y:a,r:c}),f+=u,a+=o}return l}return function n(r,s,o){o%=j,o<0&&(o+=j);var u=o>j*.75||o<j*.25,a=o<0||o>B,l=C(o),c=k(o),h=0,p=e(r,s,c/l,u,i),d=t(r,s,l/c,a,i),h=Math.min(p.dist,d.dist),n=p.concat(d),v=u?1:-1,m=a?1:-1;n.sort(function(e,t){return v*(t.x-e.x)-m*(t.y-e.y)});for(var g=0;g<n[f];g++){var y=n[g];if(O(r,s,y.x,y.y)>h){n.splice(g,1),g--;continue}n[g]=y.r}return{x:r,y:s,v:o,dist:h,ray:n}}}(),h=function(e,t,n){var r=[],i=Math.cos(n),s=Math.sin(n);for(var o=0,u=this.get(e,t);o<c&&u!==null;o++,u=this.get(e+=i,t+=s))r.push(u);return{x:e,y:t,v:n,dist:o,ray:r.reverse()}};return{get:function(e,t){return i[e|e][t|t]},set:function(e,t,n){i[e|e][t|t]=n},width:function(){return t},height:function(){return n},rect:a,ray:e.fastRaycast?h:l}}();e.map(h,r);var v=[];y.prototype.playerMove=function(e){var t=g(90);this.v+=this.t/(2*j)*e,this.v%=j,this.v<0&&(this.v+=j);var n=this.x,r=this.y,i=this.s,s=this.l,o=this.v;n=S(n+(i*C(o)+s*C(o+t))*e,h.width()),r=S(r+(i*k(o)+s*k(o+t))*e,h.height()),h.get(n,r)!==null?(this.x=n,this.y=r):h.get(this.x,r)!==null?this.y=r:h.get(n,this.y)!==null&&(this.x=n)},y.prototype.pointMove=function(e){var t=this.points[f],n=this.x,r=this.y,i=this.clr,s=e*t|0;s>t*2&&(s=t*2);for(var o=!1;s>0;s-=1,o=!1){var u=this.points.shift(),a,l=O(u.x,u.y,n,r),c=H([u.x-1,u.x,u.x+1]),h=H([u.y-1,u.y,u.y+1]);for(var p=0,d=c[p];!o&&p<3;d=c[++p])for(var v=0,m=h[v];!o&&v<3;m=h[++v])o=this.pointMoveLogic(u,n,r,d,m,l,i);this.points.push(u)}},y.prototype.pointMoveLogic=function(e,t,n,r,i,s,o){if(O(r,i,t,n)<=s){if((px=h.get(r,i))===M())return h.set(r,i,h.get(e.x,e.y)),h.set(e.x,e.y,M()),e.x=r,e.y=i,!0;if(px){var u=px.hslMix(e.c.hslMix(o,.9),.5);return px.r=u.r,px.g=u.g,px.b=u.b,px.player!==this&&px.closestTo(px.player.clr,o)===o&&px.player.points.transfer(r,i,this),!0}}return!1},y.prototype.move=function(e){this.s=S((e+this.s)/2,1,-1)},y.prototype.strafe=function(e){this.l=S((e+this.l)/2,1,-1)},y.prototype.turn=function(e){this.t=S((e+this.t)/2,1,-1)};var b=new y(U.fromArray(o),function(){var e=q;(e.UP||e.W)&&this.move(1),(e.DOWN||e.S)&&this.move(-1),e.UP||e.DOWN||e.W||e.S||this.move(0),e.A&&this.strafe(-1),e.D&&this.strafe(1),!e.A&&!e.D&&this.strafe(0),(q.LEFT||q.Q)&&this.turn(-1),(q.RIGHT||q.E)&&this.turn(1),e.LEFT||e.RIGHT||e.Q||e.E||this.turn(0)}),w=u.slice(0,e.numCPUs);for(var E in w)w[E]=new y(U.fromArray(w[E]),function(){function o(){var e=H(v);for(var t=0;t<e[f];t++){i=e[t];if(i!==s&&i.points[f]>0)break}}var e=0,t=0,n=0,i,s;return a.push(setInterval(function(){(!i||i.points[f]==0||P()<.13)&&o();var u=i.points.slice(0,13),a=0,l=0,c=0,h;while(h=u.pop())a+=h.x,l+=h.y,c++;var p=a/c-s.x,d=l/c-s.y,v=A(d,p),m=A(k(v-s.v),C(v-s.v));e=(T(p)+T(d))/r,t=P()-.5,n=m>0?1:-1},420)),function(){s=this,this.move(e),this.strafe(t),this.turn(n)}}());var N=function(e){var t=U(.96,.98,.99,1),r=U(.04,.02,.02,1),s=n;return function(){var o=i/n.canvas.width,u=e.v-i/2,a=e.v+i/2,l=s.getImageData(0,0,s.canvas.width,1),p=l.data,d=0;for(var v=0,m=u;m<=a;v++,m+=o){var g=h.ray(e.x,e.y,m),y=r.rgbMix(t,g.dist/c);for(var b,w=0,E=g.ray[f];w<E;w++)if(b=g.ray[w])y=y.rgbMix(b,.25);y=y.toArray();for(var S=0;S<4;S++)p[v*4+S]=y[S];d=Math.max(50,d,g.dist)}s.putImageData(l,0,0),c=d+10}}(b),L=function(e){function u(s){var u=s.x-e.x+i,a=s.y-e.y+o;u>0&&u<n&&a>0&&a<r&&(t.strokeStyle=t.fillStyle=s.clr.rgbMix(U(1,1,1),.75).toString(),t.fillRect(u-1,a-1,2,2),t.beginPath(),t.moveTo(u,a),t.lineTo(u+3*C(s.v),a+3*k(s.v)),t.stroke())}function a(){t.fillStyle="white";var s=t.getImageData(0,0,n,r),u=s.data;for(var a=0,f=e.y-o;f<e.y+o;f++)for(x=e.x-i;x<e.x+i;x++,a++){var l=h.get(S(x,h.width()),S(f,h.height())),c=l?l.toArray():!1;for(var p=0;p<4;p++)l===null?u[a*4+p]=255:c?u[a*4+p]=c[p]:u[a*4+p]=0}t.putImageData(s,0,0)}var t=s,n=t.canvas.width,r=t.canvas.height,i=n/2,o=r/2;return function(){t.clearRect(0,0,n,r),a(),u(e)}}(b),F=!0,I=0;m(function(e){var t="equestAnimationFrame",n=window["r"+t]||window["mozR"+t]||window["webkitR"+t]||window["msR"+t]||function(e){setTimeout(e,50)};return function(){if(F){var t=(new Date).getTime();d(v,function(e){e.tick(t)}),N(),L(),I%10==0&&D(),n(e),I++}}})()}var r=200,i=g(75),s="#00EEEE",o=[0,0,1],u=[[1,0,0],[0,1,0],[1,1,0],[1,0,1],[1,.5,0],[.5,1,0],[.5,0,0],[0,.5,0],[.5,.5,0],[.5,0,.5],[.5,.25,0],[0,.5,.5],[.5,.5,.5]],a=[],f="length",l=10,c=150,h={Box:function(e,t){for(var n=1;n<5;n++)for(var r=1;r<5;r++)e.rect(n*t/5-13,r*t/5-13,26,26)},Pillr:function(e,t){var n=t/8;e.rect(n,n,t-n*2,n),e.rect(n,t-n*2,t-n*2,n),e.rect(n,n*3,n,t-n*5),e.rect(t-n*2,n*2,n,t-n*5),e.rect(t/2-n,t/2-n,n*2,n*2)},E:function(e,t){var n=t/8;e.rect(n/1.5,n,n,t-n*2),e.rect(n*2.5,n,t-n*3,n),e.rect(n*2.5,n*3,t-n*2.5,n*2),e.rect(n*2.5,n*6,t-n*3,n)},Arena:function(e,t){var n=t/8;e.rect(t-n*1.25,n*.25,n,t-n*.5),e.rect(n*.25,t-n*1.25,t-n*.5,n),e.rect(n*.25,n*.25,n,t-n*.5),e.rect(n*.25,n*.25,t-n*.5,n)},Checkrs:function(e,n){var r=n/8;t=!1;for(var i=0;i<8;i++){for(var s=0;s<8;s++)t&&e.rect(1+i*r,1+s*r,r-2,r-2),t=!t;t=!t}}},p=h.Box,N=Math.sqrt,C=Math.cos,k=Math.sin,L=Math.tan,A=Math.atan2,D=function(e){return n.createElement(e)},P=Math.random,H=function(){function e(){return P()-.5}return function(t){return t.sort(e),t}}(),B=Math.PI,j=B*2,I=function(){var e=D("A");return e.addEventListener?function(e,t,n){return t.addEventListener(e,function(e){n(e||window.event)},!1)}:e.attachEvent?function(e,t,n){return t.attachEvent("on"+e,function(e){n(e||window.event)})}:function(e,t,n){e="on"+e;var r=t[e];r?t[e]=function(e){e=e||window.event,r(e),n(e)}:t[e]=function(e){e=e||window.event,n(e)}}}(),q=function(){var t={},n={37:"LEFT",38:"UP",39:"RIGHT",40:"DOWN"};return I("keydown",e,function(e){var r=e.keyCode;r in n?t[n[r]]=!0:t[String.fromCharCode(r)]=!0}),I("keyup",e,function(e){var r=e.keyCode;r in n?t[n[r]]=!1:t[String.fromCharCode(r)]=!1}),t}(),R=function(){if(typeof e.innerWidth=="number")return function(){return{width:e.innerWidth,height:e.innerHeight}};if(n.documentElement&&(n.documentElement.clientWidth||n.documentElement.clientHeight))return function(){return{width:document.documentElement.clientWidth,height:document.documentElement.clientHeight}};if(n.body&&(n.body.clientWidth||n.body.clientHeight))return function(){return{width:document.body.clientWidth,height:document.body.clientHeight}}}();U.prototype.toHsla=function(){var e=F(513);return function(){var t=""+this.valueOf(),n=e(t);if(n)return n.slice(0);var r=this.r,i=this.g,s=this.b,o=Math.max(r,i,s),u=Math.min(r,i,s),a,f,l=(o+u)/2;if(o==u)a=f=0;else{var c=o-u;f=l>.5?c/(2-o-u):c/(o+u);switch(o){case r:a=(i-s)/c+(i<s?6:0);break;case i:a=(s-r)/c+2;break;case s:a=(r-i)/c+4}a/=6}return e(t,[a,f,l,this.a])}}(),U.prototype.clone=function(){return new U(this.r,this.g,this.b,this.a)},U.prototype.hue=function(){var e=F(360);return function(){var t=""+this.toString(),n=e(t);if(n)return n;var r=this.r,i=this.g,s=this.b;return e(t,r>=i?r>=s?i>=s?60*((i-s)/(r-s)):60*(6-(s-i)/(r-i)):60*(4+(r-i)/(s-i)):i>=s?s>=r?60*(2+(s-r)/(i-r)):60*(2-(r-s)/(i-s)):60*(4-(i-r)/(s-r)))}}(),U.prototype.rgbMix=function(e,t){var n=this.a+e.a*(1-this.a),r=this.clone(),i=e.clone();return r.a=1-t,i.a=t,new U((r.r*r.a+i.r*i.a*(1-r.a))/n,(r.g*r.a+i.g*i.a*(1-r.a))/n,(r.b*r.a+i.b*i.a*(1-r.a))/n,n)},U.prototype.hslMix=function(e,t){t=t===M()?.5:t;var n=1-t,r=this.toHsla(),i=e.toHsla();return z(t*r[0]+n*i[0],t*r[1]+n*i[1],t*r[2]+n*i[2],r[3]+i[3]*(1-r[3]))},U.prototype.closestTo=function(e,t){var n=this.hue(),r=e.hue(),i=t.hue();return b(n-r)<b(n-i)?e:t},U.prototype.valueOf=function(){return(Math.round(255*this.r)*65536+Math.round(255*this.g)*256+Math.round(255*this.b)).toString(16)},U.prototype.toString=function(){var e=this.valueOf();return"#"+"00000".substr(0,6-e[f])+e},U.prototype.toArray=function(){return[255*this.r,255*this.g,255*this.b,255*this.a]},U.fromArray=function(e){return new U(e[0],e[1],e[2],e[3])};var z=function(){var e=F(255);return function(n,r,i,s){var o=""+n+""+r+""+i+""+s+"",u=e(o);if(u)return u.clone();var a,f,l;if(r==0)a=f=l=i;else{function c(e,t,n){return n<0?n+=1:n>1&&(n-=1),n<1/6?e+(t-e)*6*n:n<.5?t:n<2/3?e+(t-e)*(2/3-n)*6:e}var h=i<.5?i*(1+r):i+r-i*r,p=2*i-h}return e(o,new U(c(p,h,n+1/3),c(p,h,n),c(p,h,n-1/3),s))}}(),X=function(){var e=_("controls"),t=_("startGame"),n=_("mapPreviews"),r=null,i=[];for(var s in h)(function(e,t){var s=W(t);I("click",s,function(t){d(i,function(e){e.style.border="none"}),t.target.style.border="3px solid blue",r=e}),i.push(s),n.appendChild(s)})(s,h[s]);return I("click",t,function(){var t={},n=parseInt(_("numCPUs").value);n=!isNaN(n)&&n>0&&n<u[f]?n:2,l=parseInt(_("startPoints").value),l=!isNaN(l)&&l>5&&l<25?l:10;var i=_("fastRaycast").checked;e.style.display="none",V({numCPUs:n,fastRaycast:i,map:h[r]})}),e}()})(window,document);</script>
</body>
</html>
