function Game(a,b){function d(){f.addBullet=!0;f.bulletsTimeout-=0.1;setTimeout(d,f.bulletsTimeout)}function c(){f.addEnemy=!0;f.enemiesTimeout-=0.9;setTimeout(c,f.enemiesTimeout)}var f=this;this.canvas=a;this.ctx=b;this.width=a.width;this.height=a.height;this.mouse={x:this.width/2,y:0};this.bullets=[];this.enemies=[];this.currentLevel=0;this.levels=[{bulletsTimeout:400,enemiesTimeout:600,startEnemies:30,enemies:30}];this.tower=new Tower(this.width/2,this.height,10,20,"rgb(0,0,0)");this.viewfinder=
new Viewfinder(0,0,20,20,"rgb(0,0,0)");this.enemiesToClean=this.toClean=0;this.addEnemy=1;this.score=0;this.lifes=3;this.beforeStart=!0;this.tweetHandler=!1;this.bulletsTimeout=400;d();this.enemiesTimeout=600;c()}Game.prototype.startFactories=function(){};Game.prototype.image=new Image;Game.prototype.image.src="data:image/  png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAABmJLR0QAAAAAAAD5Q7t/AAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH3AkLDSMPVfdqJwAAAWRJREFUOMttk79rwlAQxz9B5UEEFwmCZigGMhQydyiEjkKhf1P/HbeOmfo3FC2CgpkMFDIIAVOC2nSwl96L3vbuvbv7/rjnHA5v9XZXkaU5k6lH4Btcd4BEWRZsdxWBb9juqiYvZ2exntf6UjeSQmkozbI0B2Ay9ei8PD+9njqGwDfsizOPD3eMhn2Ox4p9cebz44vvHxgN+/R6htGwz3hsOHUMWZrj1PV7LZ11BL4BuJnXlJzFel5naU4c+xY8gDj2AXDdAUmyas6SA+gKF4Ao9Kzp+uFsdm8hKcsCwKYgha47sAQTUdt3AI7YKNNvqa1RiivyxrIxS3MLqsDU6DSthkKSrJop7YUqy6IpWG5ya6Gi0Ls0WG7yK+v0Qz29bauzWM/rKPSsSRq+LrxlcTfwDf8ILsKIoHqaXl+txdVfaG+bjraFzSK14YH3d/Zaol2aRCEN5W4bnqgvumgK4pA4UJYFvxvMELAqKY7sAAAAAElFTkSuQmCC";
Game.prototype.clear=function(){this.ctx.fillStyle="rgb(245,245,245)";this.ctx.fillRect(0,0,255,255)};Game.prototype.tile=function(){for(x=0;x<=this.width;x+=16)for(y=0;y<=this.width;y+=16)this.ctx.drawImage(this.image,x,y)};
Game.prototype.draw=function(){var a=this;if(this.beforeStart)this.clear(),this.drawSplash(this.ctx),this.canvas.addEventListener("click",function(){a.blockClick||(a.beforeStart=!1)});else if(1>this.lifes)this.clear(),this.drawResult(this.ctx),this.tweetHandler||(this.canvas.addEventListener("click",function(){window.open("https://twitter.com/share?url="+encodeURIComponent(location.href)+"&text="+encodeURIComponent("Just ended canon defense! My score is: "+a.score+". Try the game at: "),"_blank")}),
this.tweetHandler=!0);else{if(this.addBullet){var b=game.tower.getDiffs(this.mouse);game.bullets.push(new Bullet(game.tower.x+20*b.dx,game.tower.y+20*b.dy,5,b.dx,b.dy,"rgba(0, 0, 0, 1)"));this.addBullet=!1}b=this.levels[this.currentLevel];if(b.enemies&&this.addEnemy){var d=Math.floor(Math.random()*(this.width-26))+2;game.enemies.push(new Enemy(d,0,26,32,"rgba(125, 50, 50, 1)"));this.addEnemy=!1;b.enemies--}var c=(d=this.enemies)&&d.length?d.length:0,f=this.bullets,j=f&&f.length?f.length:0,k=!1,l=
!1;if(c&&j)for(var e=0;e<c;e++){var g=d[e];if(g&&g.live)for(var i=0;i<j;i++){var h=f[i];if(h){var l=k=!1,m=g.y+g.h,n=h.y-h.w;g.y<h.y+h.w&&m>n&&(l=!0);var m=g.x,n=g.x+g.w,o=h.x-h.w,h=h.x+h.w;l&&(m<h&&n>o)&&(k=!0);if(k){console.log("BUUM!!!!");d[e].kill();f[i]=!1;this.enemiesToClean++;this.toClean++;this.score++;break}}}}this.tile();for(e=0;e<c;e++)g=d[e],!g||g.y>this.height?(g&&this.lifes--,d[e]=!1,this.enemiesToClean++):(d[e].draw(this.ctx,e),g.toRemove&&(d[e]=!1,this.enemiesToClean++));for(e=0;e<
j;e++)c=f[e],!c||c.x>this.width||c.y>this.height||0>c.x+c.w||0>c.y+c.h||c.offset>this.height?(f[e]=!1,this.toClean++):f[e].draw(this.ctx,e);this.drawInfo(this.ctx);this.tower.draw(this.ctx,this.mouse);this.viewfinder.draw(this.ctx,this.mouse);2<this.toClean&&(this.bullets=f.filter(function(a){return a}),this.toClean=0);0<this.enemiesToClean&&(this.enemies=d.filter(function(a){return a}),this.enemiesToClean=0);!b.enemies&&!this.enemies.length&&this.changeLevel()}};
Game.prototype.changeLevel=function(){var a=this;this.enemies=[];this.bullets=[];this.currentLevel++;this.beforeStart=!0;this.levels[this.currentLevel]||(this.levels[this.currentLevel]=this.levels[this.currentLevel-1],this.levels[this.currentLevel].enemiesTimeout-=50,this.levels[this.currentLevel].bulletsTimeout-=25,this.levels[this.currentLevel].enemies=this.levels[this.currentLevel].startEnemies+=10);var b=this.levels[this.currentLevel];this.bulletsTimeout=b.bulletsTimeout;this.enemiesTimeout=b.enemiesTimeout;
this.blockClick=!0;setTimeout(function(){a.blockClick=false},200)};Game.prototype.drawInfo=function(a){a.fillStyle="red";a.font="bold 30pt Calibri";a.fillText(Array(this.lifes+1).join("\u2665"),20,this.height-10);a.fillStyle="rgba(0,0,0, 0.9)";a.font="bold 14pt Calibri";a.fillText("SCORE: "+this.score,this.width/2+20,this.height-10);a.fillStyle="rgba(0,0,0, 0.6)";a.font="bold 12pt Calibri";a.fillText("Level: "+(this.currentLevel+1)+" wave:"+this.levels[this.currentLevel].enemies,10,14)};
Game.prototype.drawResult=function(a){a.fillStyle="red";a.font="italic 30pt Calibri";a.fillText("GAME OVER!",10,90);a.font="italic 20pt Calibri";a.fillText("Killed: "+this.score,70,140);a.fillStyle="blue";a.font="italic 15pt Calibri";a.fillText("Click to tweet your score!",20,180);a.font="italic 10pt Calibri";a.fillText("Refresh to play again :)",60,200)};
Game.prototype.drawSplash=function(a){0==this.currentLevel?(a.fillStyle="black",a.font="bold 20pt Calibri",a.fillText("Click or tap to start!",10,100)):(a.fillStyle="black",a.font="bold 18pt Calibri",a.fillText("Click or start level: "+(this.currentLevel+1),10,100));a.font="13pt Calibri";a.fillText("Tip: click or tap for instant fire",10,200)};
Game.prototype.getMouse=function(a){var b=canvas,d=0,c=0;if(void 0!==b.offsetParent){do d+=b.offsetLeft,c+=b.offsetTop;while(b=b.offsetParent)}a.targetTouches&&a.targetTouches[0]?(b=a.targetTouches[0].pageX-d,a=a.targetTouches[0].pageY-c):(b=a.pageX-d,a=a.pageY-c);return{x:b,y:a}};