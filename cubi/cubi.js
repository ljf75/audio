(function(){function e(e,t){return[].slice.call((t||document).querySelectorAll(e))}if(!window.addEventListener)return;var t=window.StyleFix={link:function(e){try{if(e.rel!=="stylesheet"||e.hasAttribute("data-noprefix"))return}catch(n){return}var r=e.href||e.getAttribute("data-href"),i=r.replace(/[^\/]+$/,""),s=e.parentNode,o=new XMLHttpRequest,u;o.onreadystatechange=function(){o.readyState===4&&u()},u=function(){var n=o.responseText;if(n&&e.parentNode&&(!o.status||o.status<400||o.status>600)){n=t.fix(n,!0,e);if(i){n=n.replace(/url\(\s*?((?:"|')?)(.+?)\1\s*?\)/gi,function(e,t,n){return/^([a-z]{3,10}:|\/|#)/i.test(n)?e:'url("'+i+n+'")'});var r=i.replace(/([\\\^\$*+[\]?{}.=!:(|)])/g,"\\$1");n=n.replace(RegExp("\\b(behavior:\\s*?url\\('?\"?)"+r,"gi"),"$1")}var u=document.createElement("style");u.textContent=n,u.media=e.media,u.disabled=e.disabled,u.setAttribute("data-href",e.getAttribute("href")),s.insertBefore(u,e),s.removeChild(e),u.media=e.media}};try{o.open("GET",r),o.send(null)}catch(n){typeof XDomainRequest!="undefined"&&(o=new XDomainRequest,o.onerror=o.onprogress=function(){},o.onload=u,o.open("GET",r),o.send(null))}e.setAttribute("data-inprogress","")},styleElement:function(e){if(e.hasAttribute("data-noprefix"))return;var n=e.disabled;e.textContent=t.fix(e.textContent,!0,e),e.disabled=n},styleAttribute:function(e){var n=e.getAttribute("style");n=t.fix(n,!1,e),e.setAttribute("style",n)},process:function(){e('link[rel="stylesheet"]:not([data-inprogress])').forEach(StyleFix.link),e("style").forEach(StyleFix.styleElement),e("[style]").forEach(StyleFix.styleAttribute)},register:function(e,n){(t.fixers=t.fixers||[]).splice(n===undefined?t.fixers.length:n,0,e)},fix:function(e,n,r){for(var i=0;i<t.fixers.length;i++)e=t.fixers[i](e,n,r)||e;return e},camelCase:function(e){return e.replace(/-([a-z])/g,function(e,t){return t.toUpperCase()}).replace("-","")},deCamelCase:function(e){return e.replace(/[A-Z]/g,function(e){return"-"+e.toLowerCase()})}};(function(){setTimeout(function(){e('link[rel="stylesheet"]').forEach(StyleFix.link)},10),document.addEventListener("DOMContentLoaded",StyleFix.process,!1)})()})(),function(e){function t(e,t,r,i,s){e=n[e];if(e.length){var o=RegExp(t+"("+e.join("|")+")"+r,"gi");s=s.replace(o,i)}return s}if(!window.StyleFix||!window.getComputedStyle)return;var n=window.PrefixFree={prefixCSS:function(e,r,i){var s=n.prefix;n.functions.indexOf("linear-gradient")>-1&&(e=e.replace(/(\s|:|,)(repeating-)?linear-gradient\(\s*(-?\d*\.?\d*)deg/ig,function(e,t,n,r){return t+(n||"")+"linear-gradient("+(90-r)+"deg"})),e=t("functions","(\\s|:|,)","\\s*\\(","$1"+s+"$2(",e),e=t("keywords","(\\s|:)","(\\s|;|\\}|$)","$1"+s+"$2$3",e),e=t("properties","(^|\\{|\\s|;)","\\s*:","$1"+s+"$2:",e);if(n.properties.length){var o=RegExp("\\b("+n.properties.join("|")+")(?!:)","gi");e=t("valueProperties","\\b",":(.+?);",function(e){return e.replace(o,s+"$1")},e)}return r&&(e=t("selectors","","\\b",n.prefixSelector,e),e=t("atrules","@","\\b","@"+s+"$1",e)),e=e.replace(RegExp("-"+s,"g"),"-"),e=e.replace(/-\*-(?=[a-z]+)/gi,n.prefix),e},property:function(e){return(n.properties.indexOf(e)?n.prefix:"")+e},value:function(e,r){return e=t("functions","(^|\\s|,)","\\s*\\(","$1"+n.prefix+"$2(",e),e=t("keywords","(^|\\s)","(\\s|$)","$1"+n.prefix+"$2$3",e),e},prefixSelector:function(e){return e.replace(/^:{1,2}/,function(e){return e+n.prefix})},prefixProperty:function(e,t){var r=n.prefix+e;return t?StyleFix.camelCase(r):r}};(function(){var e={},t=[],r={},i=getComputedStyle(document.documentElement,null),s=document.createElement("div").style,o=function(n){if(n.charAt(0)==="-"){t.push(n);var r=n.split("-"),i=r[1];e[i]=++e[i]||1;while(r.length>3){r.pop();var s=r.join("-");u(s)&&t.indexOf(s)===-1&&t.push(s)}}},u=function(e){return StyleFix.camelCase(e)in s};if(i.length>0)for(var a=0;a<i.length;a++)o(i[a]);else for(var f in i)o(StyleFix.deCamelCase(f));var l={uses:0};for(var c in e){var h=e[c];l.uses<h&&(l={prefix:c,uses:h})}n.prefix="-"+l.prefix+"-",n.Prefix=StyleFix.camelCase(n.prefix),n.properties=[];for(var a=0;a<t.length;a++){var f=t[a];if(f.indexOf(n.prefix)===0){var p=f.slice(n.prefix.length);u(p)||n.properties.push(p)}}n.Prefix=="Ms"&&!("transform"in s)&&!("MsTransform"in s)&&"msTransform"in s&&n.properties.push("transform","transform-origin"),n.properties.sort()})(),function(){function e(e,t){return i[t]="",i[t]=e,!!i[t]}var t={"linear-gradient":{property:"backgroundImage",params:"red, teal"},calc:{property:"width",params:"1px + 5%"},element:{property:"backgroundImage",params:"#foo"},"cross-fade":{property:"backgroundImage",params:"url(a.png), url(b.png), 50%"}};t["repeating-linear-gradient"]=t["repeating-radial-gradient"]=t["radial-gradient"]=t["linear-gradient"];var r={initial:"color","zoom-in":"cursor","zoom-out":"cursor",box:"display",flexbox:"display","inline-flexbox":"display",flex:"display","inline-flex":"display"};n.functions=[],n.keywords=[];var i=document.createElement("div").style;for(var s in t){var o=t[s],u=o.property,a=s+"("+o.params+")";!e(a,u)&&e(n.prefix+a,u)&&n.functions.push(s)}for(var f in r){var u=r[f];!e(f,u)&&e(n.prefix+f,u)&&n.keywords.push(f)}}(),function(){function t(e){return s.textContent=e+"{}",!!s.sheet.cssRules.length}var r={":read-only":null,":read-write":null,":any-link":null,"::selection":null},i={keyframes:"name",viewport:null,document:'regexp(".")'};n.selectors=[],n.atrules=[];var s=e.appendChild(document.createElement("style"));for(var o in r){var u=o+(r[o]?"("+r[o]+")":"");!t(u)&&t(n.prefixSelector(u))&&n.selectors.push(o)}for(var a in i){var u=a+" "+(i[a]||"");!t("@"+u)&&t("@"+n.prefix+u)&&n.atrules.push(a)}e.removeChild(s)}(),n.valueProperties=["transition","transition-property"],e.className+=" "+n.prefix,StyleFix.register(n.prefixCSS)}(document.documentElement),Function.prototype.bind=Function.prototype.bind||function(e){var t=[].slice,n=t.call(arguments,1),r=this,i=function(){},s=function(){return r.apply(this instanceof i?this:e||{},n.concat(t.call(arguments)))};return s.prototype=this.prototype,s},Utils={needsReducedLayout:function(){return document.body.className.indexOf("reduced")!==-1},merge:function(e,t){var n={},r=null;for(r in e)n[r]=e[r];for(r in t)n[r]=t[r];return n},addObserverMethodsToClass:function(e){e.prototype.initListeners=function(){typeof this.listeners=="undefined"&&(this.listeners={})},e.prototype.on=function(e,t){this.initListeners(),this.listeners[e]=this.listeners[e]||[],this.listeners[e].push(t)},e.prototype.off=function(e,t){this.initListeners(),this.listeners[e]=this.listeners[e].filter(function(e){return e!=t})},e.prototype.fire=function(e,t){this.initListeners(),t=t||[],t=Array.isArray(t)?t:[t],t.unshift(this),(this.listeners[e]||[]).forEach(function(e){e.apply(this,t)}.bind(this))}},interpolate:function(e,t){var n=e;for(var r in t)n=n.replace(new RegExp("%{"+r+"}","g"),t[r]);return n},createDomNode:function(e,t){var n=document.createElement(e),r=null;(t||{}).hasOwnProperty("value")&&(r=t.value,delete t.value),r!==null&&n.appendChild(document.createTextNode(r));if(typeof t!="undefined")for(var i in t)i.indexOf("-")!==-1?n.setAttribute(i,t[i]):n[i]=t[i];return n}},NodeList.prototype.forEach=Array.prototype.forEach,function(){window.currentPopUp=null;var e=function(e){this.dom=document.createElement("div"),this.dom.className="pop-up",this.content=e};Utils.addObserverMethodsToClass(e),e.notify=function(t,n){n=n||{};var r=new e(t);r.render(),n.sticky||setTimeout(function(){window.currentPopUp===r&&r.close()},2e3)},e.prototype.setContent=function(e){this.content=e},e.prototype.render=function(e){e=e||{},typeof this.content=="string"&&(this.content=document.createTextNode(this.content)),this.dom.appendChild(this.content),window.currentPopUp&&window.currentPopUp.close(),this.setPosition(e),document.body.appendChild(this.dom),window.currentPopUp=this,t.call(this)},e.prototype.setPosition=function(e){e=e||{},e.left&&(this.dom.style.left=e.left+"px"),e.top&&(this.dom.style.top=e.top+"px")},e.prototype.close=function(){document.body.removeChild(this.dom),window.currentPopUp=null};var t=function(){var e=document.querySelector("table"),t=document.querySelector(".selected, .with-range"),n=this.dom.offsetWidth,r=this.dom.offsetHeight,i=e.offsetLeft,s=i+e.offsetWidth-n,o=e.offsetTop,u=o+e.offsetHeight-r,a={};t&&t.offsetLeft>s&&t.offsetLeft<s+n&&(s=t.offsetLeft-n-10),s<i&&(s=i),this.dom.offsetLeft<i&&(a.left=i),this.dom.offsetLeft>s&&(a.left=s),this.dom.offsetTop<o&&(a.top=o),this.dom.offsetTop>u&&(a.top=u),(a.top||a.left)&&this.setPosition(a)};window.PopUp=e}(),function(){var e=function(e){this.game=e};e.prototype.init=function(){r.call(this),i.call(this),t.call(this)};var t=function(){this.game.on("rendered",function(){h.call(this)}.bind(this))},n=function(e){e.on("spawned",function(){e.round!==13&&h.call(this,e)}.bind(this)),e.on("monster:spawned",function(e,t){var n=null;this.game.player.on("killed",function(){clearInterval(n)}),this.game.player.on("won",function(){clearInterval(n)}),t.on("killed",function(){clearInterval(n),this.game.player.earn(t.options.revenue),this.game.player.recordStat("killedMonsters",1)}.bind(this)),t.on("goal:reached",function(){this.game.player.hurt()}.bind(this)),t.on("move",function(){n&&clearInterval(n),n=setInterval(function(){if(this.game.player.isDead()){clearInterval(n);return}this.game.towers.forEach(function(e){e.checkDistanceTo(t)})}.bind(this),100)}.bind(this))}.bind(this)),this.game.player.on("killed",function(){e.stop()}.bind(this)),this.game.player.on("won",function(){e.stop()}.bind(this));var t=function(){var t=(document.getElementById("wave-duration").className||"").indexOf("disabled")===-1;t&&e.forceSpawn()};this.game.on("wave:spawn",t),e.on("spawned",function(){this.game.off("wave:spawn",t)}.bind(this)),e.on("timer:disabled",function(){this.game.disableForcedSpawn()}.bind(this)),e.on("timer:enabled",function(){this.game.enableForcedSpawn()}.bind(this)),e.round===13&&e.on("cleared",function(){this.game.player.fire("won")}.bind(this))},r=function(){this.game.player.on("killed",function(){u.call(this,"Oh my gosh, you died!")}.bind(this)),this.game.player.on("won",function(){u.call(this,"Woot woot! You've won the match!")}.bind(this))},i=function(){this.game.grid.cells.forEach(function(e){e.forEach(function(e){e.on("click",function(){f.call(this);switch(e.type){case GridCell.TYPES.INACCESSABLE:s.call(this,e);break;case GridCell.TYPES.TOWER:o.call(this,e)}}.bind(this))}.bind(this))}.bind(this))},s=function(e){c.call(this,e),a.call(this)},o=function(e){a.call(this);var t=this.game.getTowerByGridCell(e),n=new TowerMetaMenu(t,this.game.player);t.renderRange(),n.render(),n.on("tower:sold",function(e,t){a.call(this),this.game.towers=this.game.towers.filter(function(e){return e!==t}),l()}.bind(this))},u=function(e){var t=Utils.createDomNode("ul",{className:"game-over"});t.appendChild(Utils.createDomNode("li",{value:e})),t.appendChild(Utils.createDomNode("li")),t.appendChild(Utils.createDomNode("li",{value:"Spent money: "+this.game.player.stats.spentMoney+"$"})),t.appendChild(Utils.createDomNode("li",{value:"Earned money: "+this.game.player.stats.earnedMoney+"$"})),t.appendChild(Utils.createDomNode("li",{value:"Killed monsters: "+this.game.player.stats.killedMonsters})),t.appendChild(Utils.createDomNode("li",{value:"Upgraded towers: "+this.game.player.stats.upgradedTowers}));var n=Utils.createDomNode("li");n.appendChild(Utils.createDomNode("a",{value:"Restart the game!",href:"#",onclick:function(){window.location.reload()}})),t.appendChild(n),PopUp.notify(t,{sticky:!0})},a=function(){this.game.towers.forEach(function(e){e.removeRange()})},f=function(){var e=document.querySelector(".selected");e&&(e.className=e.className.split(" ").filter(function(e){return e!="selected"}))},l=function(){window.currentPopUp&&window.currentPopUp.close()},c=function(e){l();if(e.hasClassName("tower"))return;(new TowerMenu(e)).render().on("select",function(t,n){if(this.game.player.canBuy(n)){var r=(new Tower(n,e)).render();r.on("upgraded",function(){this.game.player.recordStat("upgradedTowers",1)}.bind(this)),this.game.player.buy(n),this.game.towers.push(r),e.fire("click")}else PopUp.notify("Too expensive!")}.bind(this))},h=function(e){var t=1,r=13;typeof e!="undefined"&&(t=e.round+1),n.call(this,(new Wave(t,this.game.grid.path)).spawn(r))};window.EventManager=e}(),function(){var e=function(e,t,n){this.rows=e,this.cols=t,this.canvas=n,this.container=document.createElement("table"),this.path=[],this.cells=[]};e.prototype.render=function(){t.call(this),this.path=n.call(this),this.path.forEach(function(e){e.setType(GridCell.TYPES.PATH)})};var t=function(){var e=this;for(var t=0;t<this.rows;t++){var n=document.createElement("tr"),r=[];for(var i=0;i<this.cols;i++){var s=new GridCell(e);r.push(s),n.appendChild(s.getElement())}this.container.appendChild(n),this.cells.push(r)}this.canvas.appendChild(this.container)},n=function(){var e=r.call(this),t=[],n=this;return e.forEach(function(e,r){e.forEach(function(e){var s=i.call(n,r,e);t.push(s)})}),t},r=function(){var e=[],t=null;for(var n=0;n<this.cols;n++){var r=[],i=t!==null?t:~~(Math.random()*this.rows),s=~~(Math.random()*this.rows);if(n%2===0)r.push(i),t=i;else{if(i===s)r.push(i);else{for(var o=i;o!==s;i>s?o--:o++)r.push(o);r.push(o)}t=s}e.push(r)}return e},i=function(e,t){var n=this.container.querySelectorAll("tr"),r=n[t];return r.querySelectorAll("td")[e].cell};window.Grid=e}(),function(){var e=function(t,n){var r=this;this.grid=t,this.type=e.TYPES.INACCESSABLE,this.dom=document.createElement("td"),this.dom.cell=this,this.dom.onclick=function(){r.fire("click")},this.setType(this.type)};Utils.addObserverMethodsToClass(e),e.TYPES={INACCESSABLE:"inaccessable",ACCESSABLE:"accessable",PATH:"path",MONSTER:"monster",TOWER:"tower"},e.prototype.getElement=function(){return this.dom},e.prototype.setType=function(e,t){this.type=e,this.dom.className=[this.type].concat(t||[]).join(" ")},e.prototype.addClassName=function(e){this.dom.className=this.dom.className.split(" ").concat([e]).join(" ")},e.prototype.removeClassName=function(e){this.dom.className=this.dom.className.split(" ").filter(function(t){return e!==t}).join(" ")},e.prototype.hasClassName=function(e){return this.dom.className.split(" ").indexOf(e)!==-1},e.prototype.getCoordinates=function(){var e=this.coordinates,t=this;return e||this.grid.cells.forEach(function(n,r){n.forEach(function(n,i){t===n&&(e=this.coordinates={x:r,y:i})})}),e},window.GridCell=e}(),function(){var e=function(e,t){this.type=t,this.options=this.getStats(),this.health=this.options.health,this.path=e,this.pathIndex=0,this.cell=null,this.intervalId=null,this.hasTriggeredKilledEvent=!1};Utils.addObserverMethodsToClass(e),e.TYPES=[{name:"beast",health:20,count:10,speed:500,revenue:40},{name:"scout-lite",health:30,count:50,speed:400,revenue:100},{name:"amphibian-lite",health:90,count:20,speed:300,revenue:100},{name:"scout-mid",health:70,count:50,speed:300,revenue:60},{name:"mech-lite",health:500,count:30,speed:500,revenue:200},{name:"mech-mid",health:1e3,count:25,speed:600,revenue:300},{name:"mech-heavy",health:1500,count:20,speed:800,revenue:400},{name:"scout-heavy",health:100,count:100,speed:200,revenue:150},{name:"tank-lite",health:5e3,count:30,speed:400,revenue:1e3},{name:"tank-lite-2",health:1e4,count:20,speed:400,revenue:1500},{name:"tank-mid",health:15e3,count:10,speed:350,revenue:2e3},{name:"tank-laser",health:2e4,count:10,speed:500,revenue:2e3},{name:"tank-heavy",health:3e4,count:5,speed:600,revenue:5e3}],e.prototype.getStats=function(){return e.TYPES.filter(function(e){return this.type===e.name}.bind(this))[0]},e.prototype.stop=function(){clearInterval(this.intervalId)},e.prototype.move=function(){n.call(this,this.path[this.pathIndex]),this.pathIndex++,this.cell?this.fire("move"):this.fire("goal:reached")},e.prototype.getPosition=function(){return this.cell&&this.cell.getCoordinates()},e.prototype.hurt=function(e){this.health-=e,this.health<=0&&this.die()},e.prototype.die=function(){this.hasTriggeredKilledEvent||(this.stop(),this.cell.setType(GridCell.TYPES.PATH),this.fire("killed"),this.hasTriggeredKilledEvent=!0)},e.prototype.isDead=function(){return this.health<=0};var t=function(){return e.TYPES.filter(function(e){return this.type===e.name}.bind(this))[0].name},n=function(e){this.cell&&this.cell.setType(GridCell.TYPES.PATH),e&&e.setType(GridCell.TYPES.MONSTER,[t.call(this)]),this.cell=e};window.Monster=e}(),function(){var e=function(e,t){this.life=13,this.cash=1e3,this.dom=t,this.canvas=document.querySelectorAll(e)[0],this.stats={spentMoney:0,earnedMoney:0,killedMonsters:0,upgradedTowers:0}};Utils.addObserverMethodsToClass(e),e.prototype.isDead=function(){return this.life===0},e.prototype.render=function(){this.dom.parentNode===null&&this.canvas.appendChild(this.dom),t.call(this),n.call(this)},e.prototype.recordStat=function(e,t){this.stats[e]+=t},e.prototype.canBuy=function(e,t){return t=typeof t=="undefined"?0:t,this.cash>=window.Tower.TYPES[e].costs[t]},e.prototype.buy=function(e,t){t=typeof t=="undefined"?0:t;var n=window.Tower.TYPES[e].costs[t];this.cash-=n,this.recordStat("spentMoney",n),this.render()},e.prototype.earn=function(e){this.cash+=e,this.recordStat("earnedMoney",e),this.render()},e.prototype.sell=function(e){this.earn(e.getPrice()/2)},e.prototype.hurt=function(){this.life--,this.render(),this.life===0&&this.fire("killed")},e.prototype.heal=function(){this.life++,this.render()};var t=function(){var e=document.getElementById("life");e||(e=document.createElement("span"),e.id="life",this.dom.appendChild(e)),e.innerHTML="HP: "+this.life.toString()+"|13"},n=function(){var e=document.getElementById("cash"),t=Utils.needsReducedLayout()?"$%{cash}":"Cash: %{cash}$";e||(e=document.createElement("span"),e.id="cash",this.dom.appendChild(e)),e.innerHTML=Utils.interpolate(t,{cash:this.cash})};window.Player=e}(),function(){var e=function(e,t){this.type=e,this.level=0,this.cell=t,this.lastShot=null,this.range=null};Utils.addObserverMethodsToClass(e),e.TYPES={TURRET:{name:"Turret",explosion:"small",explosionOffset:-6,costs:[50,100,200],damages:[3,5,7],ranges:[1,1.5,2],frequencies:[300,225,150]},ROCKET:{name:"Rocket Tower",explosion:"mid",explosionOffset:-12,costs:[200,400,600],damages:[200,300,400],ranges:[5,7,9],frequencies:[3e3,2e3,1e3]},ULTRA:{name:"Ultra Tower",explosion:"big",explosionOffset:-20,costs:[5e3,7500,1e4],damages:[99999,99999,99999],ranges:[3,8,13],frequencies:[1e4,7500,5e3]}},e.prototype.getStats=function(){var e={damage:this.getDamage(),range:this.getRange(),frequency:this.getFrequency()/1e3};return e.damagePerSecond=Math.ceil(1/e.frequency*(1/e.frequency)*e.damage),e},e.prototype.upgrade=function(){this.level++,this.cell.setType(GridCell.TYPES.TOWER,n.call(this)),this.fire("upgraded")},e.prototype.render=function(){return this.cell.setType(GridCell.TYPES.TOWER,n.call(this)),this},e.prototype.getPrice=function(){return e.TYPES[this.type].costs[this.level]},e.prototype.getRange=function(){return e.TYPES[this.type].ranges[this.level]},e.prototype.getFrequency=function(){return e.TYPES[this.type].frequencies[this.level]},e.prototype.getDamage=function(){return e.TYPES[this.type].damages[this.level]},e.prototype.getExplosion=function(){return e.TYPES[this.type].explosion},e.prototype.getExplosionOffset=function(){return e.TYPES[this.type].explosionOffset},e.prototype.checkDistanceTo=function(e){var t=e.cell&&e.cell.dom;if(t){var n=this.pointIsInRange({x:t.offsetLeft+t.offsetWidth/2,y:t.offsetTop+t.offsetHeight/2});n&&this.canShoot()&&(this.shoot(e),this.lastShot=+(new Date))}},e.prototype.pointIsInRange=function(e){var n=this.getRange()*this.cell.dom.offsetHeight,r=t.call(this).x,i=t.call(this).y;if(Math.abs(r-e.x)<n&&Math.abs(i-e.y)<n){var s=Math.pow(r-e.x,2)+Math.pow(i-e.y,2);return s<=n*n}return!1},e.prototype.canShoot=function(){if(!this.lastShot)return!0;var e=+(new Date)-this.lastShot;return e>=this.getFrequency()},e.prototype.shoot=function(e){var t=document.createElement("div"),n=Utils.createDomNode("div",{className:"explosion "+this.getExplosion()}),r=document.body,i=e.cell.dom.offsetLeft,s=e.cell.dom.offsetTop;t.className="bullet "+this.type,t.style.left=this.cell.dom.offsetLeft+this.cell.dom.offsetWidth/2+"px",t.style.top=this.cell.dom.offsetTop+this.cell.dom.offsetHeight/2+"px",r.appendChild(t),setTimeout(function(){t.style.left=e.cell.dom.offsetLeft+e.cell.dom.offsetWidth/2+"px",t.style.top=e.cell.dom.offsetTop+e.cell.dom.offsetHeight/2+"px"}.bind(this),10),setTimeout(function(){r.removeChild(t),e.hurt(this.getDamage()),n.style.left=parseInt(t.style.left,10)+this.getExplosionOffset()+"px",n.style.top=parseInt(t.style.top,10)+this.getExplosionOffset()+"px",r.appendChild(n),setTimeout(function(){r.removeChild(n)},this.type==="ultra"?1e3:400)}.bind(this),240)},e.prototype.renderRange=function(){var e=document.createElement("div"),n=this.cell.dom,r=n.offsetHeight;e.className="range",e.style.width=e.style.height=this.getRange()*2*n.offsetHeight+"px";var i=t.call(this).x-parseInt(e.style.width,10)/2-2,s=t.call(this).y-parseInt(e.style.height,10)/2-2;e.style.left=i+"px",e.style.top=s+"px",this.range=e,this.range.onclick=function(){this.removeRange(),this.cell.removeClassName("with-range"),window.currentPopUp&&window.currentPopUp.close()}.bind(this),document.body.appendChild(e),this.cell.addClassName("with-range")},e.prototype.removeRange=function(){var e=document.body;this.range&&e.removeChild(this.range),this.range=null},e.prototype.destroy=function(){n.call(this).forEach(function(e){this.cell.removeClassName(e)}.bind(this))};var t=function(){return{x:this.cell.dom.offsetLeft+this.cell.dom.offsetWidth/2,y:this.cell.dom.offsetTop+this.cell.dom.offsetHeight/2}},n=function(){var e=this.type.toLowerCase().replace(/ /,"-"),t="level-"+(this.level+1);return[e,t]};window.Tower=e}(),function(){var e=function(e){this.cell=e,this.popUp=new PopUp};Utils.addObserverMethodsToClass(e),e.prototype.render=function(){var e=document.getElementById("tower-menu"),n=this.cell.dom.offsetLeft+40,r=this.cell.dom.offsetTop-30;return this.cell.addClassName("selected"),this.popUp.setContent(t.call(this)),this.popUp.render({left:n,top:r}),this},e.prototype.remove=function(){this.popUp.close(),this.cell.removeClassName("selected")};var t=function(){var e=Utils.createDomNode("ul",{id:"tower-menu",className:"menu"});for(var t in Tower.TYPES)n.call(this,t,e);return e},n=function(e,t){var n=this,r=Tower.TYPES[e],i=Utils.needsReducedLayout()?"%{costs}$":"%{name} (%{costs}$)",s=Utils.interpolate(i,{name:r.name,costs:r.costs[0]});t.appendChild(Utils.createDomNode("li",{value:s,"data-tower-type":e,className:e.toLowerCase(),onclick:function(){n.fire("select",this.getAttribute("data-tower-type"))}}))};window.TowerMenu=e}(),function(){var e=function(e,t){this.tower=e,this.player=t,this.popUp=new PopUp};Utils.addObserverMethodsToClass(e),e.prototype.render=function(){var e=document.createElement("ul"),i=this.tower.cell.dom.offsetLeft+40,s=this.tower.cell.dom.offsetTop-30;e.className="menu",e.appendChild(t.call(this)),e.appendChild(r.call(this)),e.appendChild(n.call(this)),this.popUp.setContent(e),this.popUp.render({left:i,top:s})},e.prototype.clear=function(){this.popUp.close()};var t=function(){var t=document.createElement("li"),n=this.tower.level+1,r=Tower.TYPES[this.tower.type].costs[n],i=Utils.needsReducedLayout()?"Level %{level}: %{costs}$":"Upgrade to Level %{level} (%{costs}$)";return n===3?(i=Utils.needsReducedLayout()?"Level %{level}: reached":"Max level %{level} reached",i=Utils.interpolate(i,{level:n,costs:r})):t.onclick=function(){this.player.canBuy(this.tower.type,n)?(this.player.buy(this.tower.type,n),this.tower.upgrade(),this.tower.removeRange(),this.tower.renderRange(),this.clear(),(new e(this.tower,this.player)).render()):(this.tower.removeRange(),PopUp.notify("Too expensive!")),i=Utils.interpolate(i,{level:n+1,costs:r})}.bind(this),t.appendChild(document.createTextNode(Utils.interpolate(i,{level:n+1,costs:r}))),t.className="upgrade",t},n=function(){var e=["%{range}","%{damage} (%{damagePerSecond}dmg/s)","1 shot/%{frequency}s"],t=this.tower.getStats(),n=document.createElement("li"),r=document.createElement("ul");for(var i=0,s=e.length;i<s;++i){var o=document.createElement("li");o.innerHTML=Utils.interpolate(e[i],t),o.className="stats-"+e[i].match(/%\{(.*?)\}/)[1],r.appendChild(o)}return n.appendChild(r),n.className="nested",n},r=function(){var e=document.createElement("li"),t=this.tower.level,n=Tower.TYPES[this.tower.type].costs[t]/2,r=Utils.interpolate("Sell: %{costs}$",{costs:n});return e.appendChild(document.createTextNode(r)),e.onclick=function(){this.player.sell(this.tower),this.tower.cell.setType(GridCell.TYPES.INACCESSABLE),this.tower.destroy(),this.fire("tower:sold",this.tower)}.bind(this),e.className="sell",e};window.TowerMetaMenu=e}(),function(){var e=function(e,t){this.round=e,this.path=t,this.speed=Monster.TYPES[this.round-1].speed,this.monstersToSpawn=Monster.TYPES[this.round-1].count,this.spawnedMonsters=0,this.monsters=[],this.meta=document.getElementById("meta-data"),this.moveIntervalId=null,this.updateTimerIntervalId=null,this.spawnTimeoutId=null,this.spawnTimeoutIds=[]};Utils.addObserverMethodsToClass(e),e.prototype.spawn=function(e){return n.call(this,e),this.spawnTimeoutId=setTimeout(function(){o.call(this)}.bind(this),e*1e3),this},e.prototype.stop=function(){this.spawnTimeoutIds.forEach(function(e){clearTimeout(e)}),clearInterval(this.moveIntervalId),clearInterval(this.spawnTimeoutId),clearInterval(this.updateTimerIntervalId)},e.prototype.forceSpawn=function(){clearTimeout(this.spawnTimeoutId),clearInterval(this.updateTimerIntervalId),i.call(this,0),o.call(this)};var t=function(){this.monsters.forEach(function(e){e.move()})},n=function(e){var t=+(new Date);this.updateTimerIntervalId=setInterval(function(){var n=+(new Date),r=Math.ceil(Math.abs(t-n)/1e3);r>e?clearInterval(this.updateTimerIntervalId):i.call(this,e-r)}.bind(this),100)},r=function(){var e=document.getElementById("wave-duration");return e||(e=document.createElement("span"),e.id="wave-duration",this.meta.appendChild(e)),e},i=function(e){var t=r.call(this),n=Utils.needsReducedLayout()?"#%{wave}: %{seconds}s":"Wave #%{wave} starts in %{seconds}s";e===0?(s.call(this,"disabled"),this.fire("timer:disabled")):(s.call(this,""),this.fire("timer:enabled")),t.innerHTML=Utils.interpolate(n,{wave:this.round,seconds:e})},s=function(e){e=Array.isArray(e)?e:[e],r.call(this).className=e.join(" ")},o=function(){for(var e=0,n=this.monstersToSpawn;e<n;e++)this.spawnTimeoutIds.push(setTimeout(u.bind(this),this.speed*e));this.on("monster:spawned",t.bind(this)),this.on("spawned",function(){this.moveIntervalId=setInterval(t.bind(this),this.speed)}.bind(this))},u=function(){var e=new Monster(this.path,Monster.TYPES[this.round-1].name),t=function(){this.monsters=this.monsters.filter(function(t){return t!==e}),this.monsters.length===0&&this.spawnedMonsters===this.monstersToSpawn&&this.fire("cleared")};e.on("killed",t.bind(this)),e.on("goal:reached",t.bind(this)),this.monsters.push(e),this.fire("monster:spawned",[e]),this.spawnedMonsters=this.spawnedMonsters+1,this.spawnedMonsters===this.monstersToSpawn&&this.fire("spawned")};window.Wave=e}(),function(){var e=function(e,t){this.options=Utils.merge({rows:10,cols:10},t||{}),this.canvas=document.querySelector(e),this.meta=Utils.createDomNode("div",{id:"meta-data"}),this.grid=new Grid(this.options.rows,this.options.cols,this.canvas),this.player=new Player(e,this.meta),this.eventManager=new EventManager(this),this.towers=[]};Utils.addObserverMethodsToClass(e),e.prototype.render=function(e){return this.grid.render(),this.player.render(),document.body.appendChild(this.meta),n.call(this),this.eventManager.init(),this.fire("rendered"),this},e.prototype.getTowerByGridCell=function(e){var t=this.towers.filter(function(t){return t.cell===e});return t.length===1?t[0]:null},e.prototype.disableForcedSpawn=function(){t.call(this).className="disabled"},e.prototype.enableForcedSpawn=function(){t.call(this).className=""};var t=function(){var e=document.getElementById("force-next-wave");return e||(e=this.meta.appendChild(Utils.createDomNode("span",{id:"force-next-wave"}))),e},n=function(){var e=t.call(this),n=Utils.needsReducedLayout()?"Next wave":"Force next wave";e.innerHTML=n,e.onclick=function(){this.fire("wave:spawn")}.bind(this)};window.Game=e}();var readyStateCheckInterval=setInterval(function(){if(document.readyState==="complete"){clearInterval(readyStateCheckInterval);var e=window,t=document,n=t.documentElement,r=t.getElementsByTagName("body")[0],i=e.innerWidth||n.clientWidth||r.clientWidth,s=e.innerHeight||n.clientHeight||r.clientHeight,o=24,u=28,a=~~((i-8-2)/o),f=~~((s-24-8-2)/u);a<20&&(document.body.className=document.body.className.split(" ").concat(["reduced"]).join(" ")),game=(new Game("body",{cols:a,rows:f})).render(),document.getElementById("meta-data").style.width=document.querySelector("table").offsetWidth-10+"px"}},10)