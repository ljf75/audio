window.requestAnimFrame=(function(a){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(b){window.setTimeout(b,0)}})();function init(){cvs=document.createElement("canvas");cvs_viewport=document.getElementById("canvas13k");ctx_viewport=cvs_viewport.getContext("2d");ctx=cvs.getContext("2d");mobile=false;if((navigator.userAgent.indexOf("iPhone")!=-1)||(navigator.userAgent.indexOf("iPod")!=-1)||(navigator.userAgent.indexOf("iPad")!=-1)){cvs.height=window.innerHeight-20;cvs.width=window.innerWidth-20;mobile=true}else{cvs.height=window.innerHeight-20;cvs.width=window.innerWidth-20}cvs_viewport.height=cvs.height;cvs_viewport.width=cvs.width;menu=document.getElementById("menu");menuGraphic=document.getElementById("menuGraphic");var a=(cvs.height>cvs.width)?cvs.width:cvs.height;menuGraphic.height=a;menuGraphic.width=a;menu.addEventListener("click",menuclick,false);menu.addEventListener("touchend",menuclick,false);window.addEventListener("mousedown",onMouseDown,false);window.addEventListener("mousemove",onMouseMove,false);window.addEventListener("mouseup",onMouseUp,false);window.addEventListener("touchstart",onMouseDown,false);window.addEventListener("touchmove",onMouseMove,false);window.addEventListener("touchend",onMouseUp,false);isMouseDown=false;mouseSensitivity=100;currentMouseCoords={x:0,y:0};sphereVelocity={x:0,y:0};sphereDecel=10;r=cvs.height<=cvs.width?cvs.height/2:cvs.width/2;r-=10;delta={theta:0,phi:0};sphere_tau=-Math.PI/6;starBoxSize=0;score=0;menuState=true;playingState=false;sphereShaker=new Vibration();twitterHandler=new TwitterHandler();twitterHandler.setText();tm={current:Date.now(),last:null,step:function(){this.last=this.current;this.current=Date.now()},delta:function(){return this.current-this.last}};sphere=makesphere();paddle=new Paddle("rgba(20,160,80,0.9)","rgba(20,160,80,0.4)",sphere[15][15]);if(!mobile){stars=makestars(500)}else{stars=makestars(200)}balls=[new Ball("green",0,0,0,0,0,0)];balls[0].isCaught=true}function shpereMain(){init();loop()}function loop(){clear();update();draw();flip();window.requestAnimFrame(function(){loop()})}function clear(){ctx.clearRect(0,0,cvs.width,cvs.height);ctx_viewport.clearRect(0,0,cvs.width,cvs.height);var a=cvs.width;cvs.width=1;cvs_viewport.width=1;cvs.width=a;cvs_viewport.width=a}function update(){tm.step();paddle.update();for(var b=0;b<stars.length;b++){stars[b].update()}for(var a=0;a<balls.length;a++){balls[a].update()}if(!isMouseDown){delta.theta+=sphereVelocity.x}sphereVelocity.x=sphereVelocity.x*0.95;if(Math.abs(sphereVelocity.x)<0.005){sphereVelocity.x=0}sphereShaker.update();for(var b=balls.length-1;b>=0;b--){if(balls[b].deleteMe==true){if(balls.length==1){balls[b].isCaught}else{delete balls[b];balls.splice(b,1)}}}if(menuState){delta.theta+=0.0001*tm.delta();if(!mobile){menu.style.left=0}else{menu.style.visibility="visible"}}}function draw(){ctx.save();ctx.translate(cvs.width/2,cvs.height/2);for(var b=0;b<stars.length;b++){ctx.beginPath();stars[b].draw();ctx.fill()}if(!paddle.isInFront){paddle.draw()}for(var a=0;a<balls.length;a++){balls[a].draw()}drawLongitudes();if(paddle.isInFront){paddle.draw()}drawScore()}function flip(){ctx_viewport.drawImage(cvs,0,0)}function drawScore(){ctx.font="50px Impact,Charcoal,sans-serif";ctx.textBaseline="Top";ctx.fillStyle="rgba(100,100,100,0.9)";ctx.fillText(score,-cvs.width*5/11,-cvs.height*5/11+60);ctx.fillStyle="rgba(200,200,200,0.9)";ctx.fillText(score,-cvs.width*5/11-3,-cvs.height*5/11+57)}function drawLongitudes(){var b="rgba(255,255,255,0.8)";var g="rgba(190,190,190,0.6)";ctx.lineWidth=2.5;var d=(mobile)?2:1;for(var a=0;a<sphere.length;a+=d){ctx.beginPath();var f=sphereToRect(r+sphereShaker.magnitude,sphere[a][0].theta+delta.theta,sphere[a][0].phi);f=rotateAboutY(f.x,f.y,f.z,sphere_tau);ctx.moveTo(Math.round(f.x),Math.round(f.y));for(var c=1;c<sphere[a].length;c+=d){var e=sphereToRect(r+sphereShaker.magnitude,sphere[a][c].theta+delta.theta,sphere[a][c].phi);e=rotateAboutY(e.x,e.y,e.z,sphere_tau);ctx.lineTo(Math.round(e.x),Math.round(e.y));if(c==15){ctx.strokeStyle=e.z>0?b:g}}ctx.stroke()}}function makesphere(){var a=[];for(var b=0;b<30;b++){a.push([]);for(var c=0;c<30;c++){a[b].push({theta:b*12/360*Math.PI*2,phi:c*6/360*Math.PI*2})}}return a}function makestars(c){var b=[];starBoxSize=cvs.width;for(var a=0;a<c;a++){b.push(new Star("white",randomRange(-starBoxSize,starBoxSize),randomRange(-starBoxSize,starBoxSize),randomRange(-starBoxSize,starBoxSize)))}return b}function rectToSphere(a,g,f){var b=Math.sqrt(a*a+g*g+f*f);var d=Math.sqrt(f*f+a*a);var c=-f>=0?Math.asin(a/d):Math.PI-Math.asin(a/d);if(d==0){c=0}var e=Math.acos(-g/b);return{rho:b,theta:c,phi:e}}function sphereToRect(a,b,c){x=a*Math.sin(c)*Math.cos(b);y=a*Math.sin(c)*Math.sin(b);z=a*Math.cos(c);return{x:y,y:-z,z:-x}}function sphereToStereoRect(a,b,c){var d=sphereToRect(a,b,c);return rectToStereoRect(d.x,d.y,d.z)}function rectToStereoRect(a,e,d){var b={x:a,y:e,z:d};var c={x:0,y:0,z:0};c.x=b.x*(-3*r)/(b.z+-3*r+-3*r);c.y=b.y*(-3*r)/(b.z+-3*r+-3*r);c.z=b.z;return c}function rotateAboutY(a,g,f,d){var e=a;var c=g*Math.cos(d)-f*Math.sin(d);var b=g*Math.sin(d)+f*Math.cos(d);return{x:e,y:c,z:b}}function rotateAboutAxisInXZPlane(){}function Star(b,a,d,c){this.pos={x:a,y:d,z:c};this.vel={x:0,y:0,z:0.1};this.color=b;this.radius=1;this.update=function(){this.pos.x+=this.vel.x*tm.delta();this.pos.y+=this.vel.y*tm.delta();this.pos.z+=this.vel.z*tm.delta();if(this.pos.z>starBoxSize){this.pos.z=-starBoxSize}};this.draw=function(){var e={x:0,y:0,z:0};e=rectToStereoRect(this.pos.x,this.pos.y,this.pos.z);ctx.arc(e.x,e.y,this.radius,0,2*Math.PI,false);ctx.fillStyle=this.color}}function Ball(e,b,g,f,d,c,a){this.trueRadius=25;deleteMe=false;this.color=e;this.pos={x:b,y:g,z:f};this.vel={x:d,y:c,z:a};this.tolerance=10;this.insideSphere=true;this.hasBounced=false;this.bounceTimerCounter=0;this.isCaught=false;this.update=function(){this.vel.y=0;this.pos.y=0;var k=Math.sqrt(this.pos.x*this.pos.x+this.pos.y*this.pos.y+this.pos.z*this.pos.z);if(this.isCaught){var l=sphereToRect(r-20,paddle.vertex.theta+delta.theta,paddle.vertex.phi);this.pos.x=l.x;this.pos.y=l.y;this.pos.z=l.z}else{if(k>r+r/2){if(balls.length==1){this.isCaught=true;menuState=true;this.vel.x=0;this.vel.y=0;this.vel.z=0}else{this.kill()}}else{if(k<r+this.tolerance&&k>r-this.tolerance){var n=rectToSphere(this.pos.x,this.pos.y,this.pos.z);n.theta=n.theta%(2*Math.PI);n.theta=Math.acos(Math.cos(n.theta));var j=(paddle.vertex.theta+delta.theta)%(2*Math.PI);j=Math.acos(Math.cos(j));var i=sphereToRect(r,paddle.vertex.theta+delta.theta,Math.PI/2);if(n.theta<0){n.theta+=Math.PI*2}if(!this.hasBounced&&n.theta<(j+paddle.deg/2)%(Math.PI*2)&&n.theta>(j-paddle.deg/2)%(Math.PI*2)&&i.x*this.pos.x>=0){this.hasBounced=true;var m=sphereToRect(r,paddle.vertex.theta+delta.theta,paddle.vertex.phi);var h=Math.sqrt(m.x*m.x+m.y*m.y+m.z*m.z);m.x=m.x/h;m.y=0;m.z=m.z/h;this.vel=reflect(m,this.vel);this.vel.x*=1.05;this.vel.z*=1.05;score+=13;sphereShaker.shake(300);if(score%39==0){this.multiball(2,m,h)}}if(k>r){this.insideSphere=false}}}}this.pos.x+=this.vel.x*tm.delta();this.pos.z+=this.vel.z*tm.delta();if(this.hasBounced){this.bounceTimerCounter++;if(this.bounceTimerCounter>10){this.bounceTimerCounter=0;this.hasBounced=false}}};this.draw=function(){var j=rotateAboutY(this.pos.x,this.pos.y,this.pos.z,sphere_tau);var i=rectToStereoRect(this.trueRadius,this.trueRadius,j.z*3);var h=i.x;ctx.beginPath();ctx.arc(j.x,j.y,h,0,2*Math.PI,false);ctx.fillStyle=this.color;ctx.closePath();ctx.fill();ctx.strokeStyle="black";ctx.stroke();if(this.insideSphere){}};this.kill=function(){this.deleteMe=true};this.explode=function(){this.deleteMe=true};this.checkCollision=function(){};this.pitch=function(){this.hasBounced=true;this.isCaught=false;score=0;var i=r/2000;var h=Math.sqrt(this.pos.x*this.pos.x+this.pos.y*this.pos.y+this.pos.z*this.pos.z);this.vel.x=-this.pos.x/h*i;this.vel.y=-this.pos.y/h*i;this.vel.z=-this.pos.z/h*i};this.multiball=function(m,n,h){for(var l=0;l<m;l++){var k="rgb("+Math.floor(randomRange(120,190))+","+Math.floor(randomRange(120,190))+","+Math.floor(randomRange(120,190))+")";var o=Math.sqrt(this.vel.x*this.vel.x+this.vel.z*this.vel.z);balls.push(new Ball(k,n.x*h,n.y*h,n.z*h,-n.x*(o+randomRange(-0.03,0.03)),0,-n.z*(o+randomRange(-0.03,0.03))));var j=balls[balls.length-1];j.pos.x+=j.vel.x*tm.delta();j.pos.z+=j.vel.z*tm.delta();j.hasBounced=true}}}function sortBalls(){var c=1;while(c){c=0;for(var b=0;b<balls.length-1;b++){if(balls[b]>balls[b+1]){var a=balls[b];balls[b]=balls[b+1];balls[b+1]=a;c++}}}}function Paddle(a,c,b){this.vertex=b;this.frontColor=a;this.rearColor=c;this.deg=0.5084;isInFront=true;this.update=function(){var d=sphereToRect(r,this.vertex.theta+delta.theta,this.vertex.phi);d=rotateAboutY(d.x,d.y,d.z,sphere_tau);this.isInFront=d.z>0?true:false};this.draw=function(){ctx.beginPath();var d=this.vertex;var e=sphereToRect(r,this.vertex.theta+delta.theta,this.vertex.phi);e=rotateAboutY(e.x,e.y,e.z,sphere_tau);var i=sphereToRect(r,this.vertex.theta-this.deg/2+delta.theta,this.vertex.phi-this.deg/2);i=rotateAboutY(i.x,i.y,i.z,sphere_tau);var h=sphereToRect(r,this.vertex.theta+this.deg/2+delta.theta,this.vertex.phi-this.deg/2);h=rotateAboutY(h.x,h.y,h.z,sphere_tau);var g=sphereToRect(r,this.vertex.theta+this.deg/2+delta.theta,this.vertex.phi+this.deg/2);g=rotateAboutY(g.x,g.y,g.z,sphere_tau);var f=sphereToRect(r,this.vertex.theta-this.deg/2+delta.theta,this.vertex.phi+this.deg/2);f=rotateAboutY(f.x,f.y,f.z,sphere_tau);ctx.moveTo(Math.round(i.x),Math.round(i.y));ctx.lineTo(Math.round(h.x),Math.round(h.y));ctx.lineTo(Math.round(g.x),Math.round(g.y));ctx.lineTo(Math.round(f.x),Math.round(f.y));ctx.fillStyle=this.isInFront?this.frontColor:this.rearColor;ctx.fill()}}function onMouseDown(a){a.preventDefault();isMouseDown=true;currentMouseCoords=getMouseCoords(a);if(balls[0].isCaught&&!menuState){balls[0].pitch()}}function onMouseUp(a){a.preventDefault();isMouseDown=false;if(!menuState){sphereVelocity.x=-(currentMouseCoords.x-lastMouseCoords.x)/mouseSensitivity;sphereVelocity.y=-(currentMouseCoords.y-lastMouseCoords.y)/mouseSensitivity}}function onMouseMove(a){a.preventDefault();lastMouseCoords=currentMouseCoords;currentMouseCoords=getMouseCoords(a);if(isMouseDown&&!menuState){delta.theta+=-(currentMouseCoords.x-lastMouseCoords.x)/mouseSensitivity}}function menuclick(a){if(menuState==true&&a.target==menuGraphic){menuState=false;if(!mobile){menu.style.left=-cvs.width-100}else{menu.style.visibility="hidden"}console.log(a.target)}}function getMouseCoords(b){var a=b.x;var c=b.y;if(b.x||b.x==0){a=b.x;c=b.y;a-=cvs.offsetLeft;c-=cvs.offsetTop}else{if(b.layerX||b.layerX==0){a=b.layerX;c=b.layerY}else{if(b.offsetX||b.offsetX==0){a=b.offsetX;c=b.offsetY}else{if(b.pageX||b.pageX==0){a=b.pageX;c=b.pageY;if(!b.changedTouches){c-=cvs.offsetTop;a-=cvs.offsetLeft}}else{a=0;c=0}}}}return{x:a,y:c}}function randomRange(d,c){return Math.random()*((d<c)?(c-d):(d-c))+((d<c)?d:c)}function reflect(e,d){var b=Math.sqrt(e.x*e.x+e.y*e.y+e.z*e.z);var c=-2*(e.x*d.x/b+e.y*d.y/b+e.z*d.z/b);var a={x:c*e.x/b+d.x,y:c*e.y/b+d.y,z:c*e.z/b+d.z};return a}function Vibration(){this.magnitude=0;this.last_magnitude=0;this.vel=0;this.accel=0;this.k=150;this.c=10;this.m=1;this.update=function(){var a=tm.delta()/1000;this.last_magnitude=this.magnitude;this.accel=(-this.k*this.magnitude+-this.c*this.vel)/this.m;this.vel=this.vel+this.accel*a;this.magnitude=this.magnitude+this.vel*a;if(Math.abs(this.vel)<=0.0001&&Math.abs(this.magnitude)>0){this.vel=0;this.magnitude=0;this.accel=0}};this.shake=function(a){this.vel+=a}}function TwitterHandler(){this.image=document.getElementById("twetGraphic");this.kitty=document.getElementById("kittyGraphic");this.anchor=document.getElementById("twetAnchor");this.url=document.location.href;this.via="mrlasertron";this.hashtags="gamedev,js13k,html5";this.image.height=r/3;this.image.width=r/3;this.kitty.height=r/3;this.kitty.width=r/3;this.text=[];this.text.push("what%20a%20terrible%20night%20for%20a%20html5%20game%20curse!");this.text.push("what%20is%20a%20man%20but%20a%20miserable%20pile%20of%20html5%20games..");this.text.push("frankly%20i%20find%20the%20idea%20of%20a%20brain%20html5%20game%20in%203D%20offensive!");this.text.push("%3A%3Aloads%20power%20loader%3A%3A%20Where%20do%20you%20want%20it%3F%20%3A%3Achuckles%3A%3A%20Bay%2013kjs.");this.text.push("Check%20out%20my%20entry%20in%20the%20js13k%20game%20compo,%20sPhere");this.setText=function(){var a=this.text[Math.floor(randomRange(0,this.text.length-1))];this.anchor.href="https://twitter.com/intent/tweet?text="+a+"&via="+this.via+"&url="+this.url+"&hashtags="+this.hashtags}};