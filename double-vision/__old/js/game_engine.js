var Actor,Box,Circle,CircleActor,Controller,Game,Keys,Loader,MathHelpers,PreloaderStage,STATE,Shape,Sprite,Stage,TileMap,Timer,Vector,bind=function(t,e){return function(){return t.apply(e,arguments)}},extend=function(t,e){function i(){this.constructor=t}for(var s in e)hasProp.call(e,s)&&(t[s]=e[s]);return i.prototype=e.prototype,t.prototype=new i,t.__super__=e.prototype,t},hasProp={}.hasOwnProperty;Loader={numberOfImages:0,numberComplete:0,images:{},loadImage:function(t,e){var i;return Loader.numberOfImages++,i=new Image,i.onload=function(){return Loader.images[t]=i,Loader.numberComplete++},i.src=e},getImage:function(t){return Loader.images[t]},getProgress:function(){return Loader.numberComplete/Loader.numberOfImages},doneLoading:function(){return 1===Loader.getProgress()}},Vector=function(){function t(t,e){this.x=null!=t?t:0,this.y=null!=e?e:0,this.subtract=bind(this.subtract,this),this.add=bind(this.add,this),this.rotate=bind(this.rotate,this)}return t.prototype.rotate=function(t){var e,i;return e=this.x,i=this.y,this.x=e*Math.cos(t)-i*Math.sin(t),this.y=e*Math.sin(t)+i*Math.cos(t)},t.prototype.add=function(e){if(e instanceof t)return this.x+=e.x,this.y+=e.y},t.prototype.subtract=function(e){if(e instanceof t)return this.x-=e.x,this.y-=e.y},t}(),Shape=function(){function t(t){this.position=t}return t}(),Circle=function(t){function e(t,i){this.radius=null!=i?i:0,e.__super__.constructor.call(this,t)}return extend(e,t),e}(Shape),Box=function(t){function e(t,i,s){this.w=null!=i?i:0,this.h=null!=s?s:0,e.__super__.constructor.call(this,t)}return extend(e,t),e}(Shape),MathHelpers={isCircleInRect:function(t,e){var i,s,r,o,n,h,a,l;if(t instanceof Circle&&e instanceof Box)return a=e.position.x,n=a+e.w,l=e.position.y,h=l+e.h,r=t.position.x-t.radius,i=t.position.x+t.radius,o=t.position.y-t.radius,s=t.position.y+t.radius,!(a>r||n<i||l>o||h<s)},doesCircleRectIntersect:function(t,e){var i,s,r,o;if(t instanceof Circle&&e instanceof Box)return i=t.position,o=e.position,s=i.x-Math.max(o.x,Math.min(i.x,o.x+e.w)),r=i.y-Math.max(o.y,Math.min(i.y,o.y+e.h)),s*s+r*r<t.radius*t.radius},doesCircleCircleIntersect:function(t,e){var i,s,r;if(t instanceof Circle&&e instanceof Circle)return i=t.position,s=e.position,r=MathHelpers.getDistance(i.x,i.y,s.x,s.y),!(t.radius+e.radius<r)},toDegrees:function(t){return t*(180/Math.PI)},toRadians:function(t){return t*(Math.PI/180)},getDistance:function(t,e,i,s){return Math.sqrt(Math.pow(i-t,2)+Math.pow(s-e,2))}},Sprite=function(){function t(t,e){this.image=t,this.spriteSize=e,this.updateFrame=bind(this.updateFrame,this),this.setCycle=bind(this.setCycle,this),this.flipped=!1,this.frame=0,this.timer=void 0}return t.prototype.draw=function(t,e,i,s){var r,o,n;return r=this.cycle[this.frame],o=r.col*this.spriteSize,n=r.row*this.spriteSize,i.save(),i.translate(t,e),i.globalAlpha=s,i.drawImage(this.image,o,n,this.spriteSize,this.spriteSize,0,0,this.spriteSize,this.spriteSize),i.restore()},t.prototype.setCycle=function(t,e){return this.cycle=t,this.interval=null!=e?e:0,this.cycleLength=this.cycle.length,this.frame=0,this.timer=new Timer(this.interval)},t.prototype.updateFrame=function(t){if(this.timer.tick(t),this.timer.hasEnded())return this.frame=(this.frame+1)%this.cycleLength,this.timer.restart()},t}(),Controller=function(){function t(){document.onkeyup=function(e){return t.pressed[e.keyCode]=!1},document.onkeydown=function(e){return t.pressed[e.keyCode]=!0}}var e;return e=null,t.pressed=new Map,t.get=function(){return null==this.instance&&(e=new this),e},t.prototype.isPressed=function(e){return t.pressed[e]},t}(),Keys={ENTER:13,LEFT:37,RIGHT:39,UP:38,DOWN:40,A:65,D:68,W:87,S:83},Actor=function(){function t(t,e,i){this.direction=null!=i?i:0,this.lookAt=bind(this.lookAt,this),this.setDirection=bind(this.setDirection,this),this.setPosition=bind(this.setPosition,this),this.setStage=bind(this.setStage,this),this.position=new Vector(t,e),this.stage=null,this.destroy=!1}return t.prototype.init=function(){if(this._init)return this._init()},t.prototype.update=function(t){if(this._update)return this._update(t)},t.prototype.render=function(){if(this._render)return this._render()},t.prototype.setStage=function(t){this.stage=t},t.prototype.setPosition=function(t,e){return null==t&&(t=0),null==e&&(e=0),this.position=new Vector(t,e)},t.prototype.setDirection=function(t){return this.direction=t*(Math.PI/180)},t.prototype.shouldDestroy=function(){return this.destroy},t.prototype.lookAt=function(t){return t instanceof Vector?this.direction=Math.atan2(t.x-this.position.y,t.x-this.position.x):void console.log("ERROR: "+t+" is not an Point")},t}(),CircleActor=function(t){function e(t,i,s,r){null==s&&(s=0),this.radius=null!=r?r:0,this.updateBody=bind(this.updateBody,this),e.__super__.constructor.call(this,t,i,s),this.body=new Circle(this.position,this.radius)}return extend(e,t),e.prototype.updateBody=function(){return this.body=new Circle(this.position,this.radius)},e}(Actor),TileMap=function(){function t(t,e,i,s,r){this.cols=null!=t?t:0,this.rows=null!=e?e:0,this.tileSize=null!=i?i:0,this.tiles=null!=s?s:[],this.ctx=null!=r?r:void 0}return t.prototype.getTile=function(t,e){return this.tiles[e*this.cols+t]},t.prototype.render=function(){if(this._render)return this._render()},t}(),Timer=function(){function t(t){this.timeout=t,this.restart=bind(this.restart,this),this.end=bind(this.end,this),this.tick=bind(this.tick,this),this.elapsed=0}return t.prototype.tick=function(t){return this.elapsed+=t},t.prototype.end=function(t){return this.elapsed=this.timeout},t.prototype.hasEnded=function(){return this.elapsed>=this.timeout},t.prototype.restart=function(){return this.elapsed=0},t}(),STATE={finished:0,running:1},Stage=function(){function t(t,e,i){this.width=t,this.height=e,this.ctx=null!=i?i:void 0,this.setContext=bind(this.setContext,this),this.addActor=bind(this.addActor,this),this.actors=[],this.bounds=new Box(new Vector,this.width,this.height),this.state=STATE.running,this.controller=Controller.get()}return t.prototype.addActor=function(t){return t instanceof Actor?(t.setStage(this),t.init(),this.actors.push(t)):void console.log("ERROR: "+t+" is not an Actor")},t.prototype.init=function(){if(this.actors=[],this.state=STATE.running,this._init)return this._init()},t.prototype.update=function(t){var e,i,s,r,o;for(this._update&&this._update(t),r=this.actors,o=[],i=0,s=r.length;i<s;i++)e=r[i],o.push(e.update(t));return o},t.prototype.render=function(){var t,e,i,s,r;for(this._render&&this._render(),s=this.actors,r=[],e=0,i=s.length;e<i;e++)t=s[e],r.push(t.render());return r},t.prototype.setContext=function(t){this.ctx=t},t.prototype.getContext=function(){return this.ctx},t.prototype.isCircleInBounds=function(t){return t instanceof Circle&&MathHelpers.isCircleInRect(t,this.bounds)},t}(),PreloaderStage=function(t){function e(t,i,s){this._update=bind(this._update,this),e.__super__.constructor.call(this,t,i,s),this.progress=Loader.getProgress()}return extend(e,t),e.prototype.drawLoaderProgress=function(){var t,e,i,s;return s=20,i=this.width-2*s,t=50,e=i*this.progress,this.ctx.strokeRect(s,this.height/2-t/2,i,t),this.ctx.fillRect(s,this.height/2-t/2,e,t)},e.prototype._init=function(){},e.prototype._update=function(t){this.progress=Loader.getProgress(),Loader.doneLoading()&&(this.state=STATE.finished)},e.prototype._render=function(){return this.ctx.save(),this.drawLoaderProgress(),this.ctx.restore()},e}(Stage),Game=function(){function t(e,i,s,r){this.canvas=null!=r?r:void 0,this.gameStep=bind(this.gameStep,this),this.render=bind(this.render,this),this.start=bind(this.start,this),this.border=bind(this.border,this),this.backgroundColor=bind(this.backgroundColor,this),this.setStage=bind(this.setStage,this),this.canvas||(this.canvas=document.createElement("canvas"),document.body.appendChild(this.canvas)),this.canvas.ctx=this.canvas.getContext("2d"),this.canvas.width=e,this.canvas.height=i,this.canvas.addEventListener("mousemove",function(e){var i;return i=this.getBoundingClientRect(),t.mousePoint=new Vector(e.clientX-i.left,e.clientY-i.top)}),this.running=!1,this.setup=s||void 0,this.stage=null,this.startTime=0,this.accumulator=0,this.actualFps=0,this.setup&&this.setup()}return t.fps=60,t.frameDuration=1e3/t.fps,t.mousePoint=void 0,t.prototype.setStage=function(t){return t instanceof Stage?(this.stage=t,this.stage.setContext(this.canvas.ctx),this.stage.init()):void console.log("ERROR: "+t+" is not an Stage")},t.prototype.setStageTransition=function(t){return this._transition=t},t.prototype.backgroundColor=function(t){return this.canvas.style.backgroundColor=t},t.prototype.border=function(t){return this.canvas.style.border=t},t.prototype.getMouseLocation=function(){return t.mousePoint},t.prototype.start=function(){return this.running=!0,this.startTime=Date.now(),this.gameStep(),window.onEachFrame(this.render)},t.prototype.update=function(t){if(null!=this._transition&&this._transition(),null!=this.stage)return this.stage.update(t)},t.prototype.render=function(){if(null!=this.running)return this.canvas.ctx.save(),this.canvas.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.canvas.ctx.restore(),null!=this.stage?this.stage.render():void 0},t.prototype.gameStep=function(){var e,i;if(null!=this.running){for(e=Date.now(),i=e-this.startTime,i>1e3&&(i=t.frameDuration),this.actualFps=1e3/i,this.startTime=e,this.accumulator+=i;this.accumulator>=t.frameDuration;)this.update(t.frameDuration),this.accumulator-=t.frameDuration;return setTimeout(this.gameStep,t.frameDuration)}},t}(),function(){var t;t=void 0,t=window.requestAnimationFrame?function(t){var e;(e=function(){t(),requestAnimationFrame(e)})()}:window.webkitRequestAnimationFrame?function(t){var e;(e=function(){t(),webkitRequestAnimationFrame(e)})()}:window.mozRequestAnimationFrame?function(t){var e;(e=function(){t(),mozRequestAnimationFrame(e)})()}:function(t){setInterval(t,Game.frameDuration)},window.onEachFrame=t}();