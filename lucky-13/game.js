function r(e,t,n){e.addEventListener?e.addEventListener(t,n,!1):e.attachEvent&&e.attachEvent("on"+t,function(){n(window.event)})}function i(r){var i=r.keyCode;n[i]=!0;var s=t[i];s&&s(i),(s||e[i])&&r.preventDefault()}function s(e){var t=e.keyCode;n[t]=!1}function o(e){return typeof e=="string"?e.toUpperCase().charCodeAt():e}function u(){r(document,"keydown",i),r(document,"keyup",s),r(window,"focus",a)}function a(){for(var e=0;e<n.length;e++)n[e]=!1}function f(e,n){t[o(e)]=n}function l(t,n){e[o(t)]=n}function c(t){for(var r in e)n[r]&&e[r](r,t)}function N(e){return h(e*x)}function L(e,t){var n=document.createElement("button");n.innerHTML=e,n.onclick=t,document.getElementById("controls").appendChild(n)}function A(){function n(e){return function(){var t=new Audio(sfx[e].src);t.volume=.5,t.play()}}var e,t;window.music=new Audio(F()),music.load(),window.sfx=[],window.newSFX=function(e){var t=sfx.length;sfx.push(new Audio(e));var r=n(t),i=String.fromCharCode(49+t);f(i,r),L(i,r)};for(var r=0;r<sfx.length;r++){var i=n(r),s=String.fromCharCode(49+r);f(s,i),L(s,i)}e=new C(.2,null,null,.5),t=new k(e,"square"),t.renderNotesPDV([[36,.03,.3],[43,.03,.4],[48,.05,.5]]),window.sfx.point={audio:new Audio(t.asDataURI()),play:function(){var e=new Audio(this.audio.src);e.play()}};var o=.4;e=new C(o,null,null,.5),t=new k(e,"saw"),t.renderNotesPDV([[0,o,.5]]),window.sfx.lose={audio:new Audio(t.asDataURI()),play:function(){var e=new Audio(this.audio.src);e.play()}}}function D(e){function o(e){u(),n=e}function u(){t.push([n+r*12,i,s]),i=M,s=_}var t=[],n=0,r=O,i=M,s=_;for(var a=0;a<e.length;a++){var f=e[a];switch(f){case"a":o(0);break;case"A":o(1);break;case"b":o(2);break;case"c":o(3);break;case"C":o(4);break;case"d":o(5);break;case"D":o(6);break;case"e":o(7);break;case"f":o(8);break;case"F":o(9);break;case"g":o(10);break;case"G":o(11);break;case"r":o(0),s=0;break;case"0":r=0;break;case"1":r=1;break;case"2":r=2;break;case"3":r=3;break;case"4":r=4;break;case"5":r=5;break;case"6":r=6;break;case"7":r=7;break;case"*":i*=2;break;case"/":i*=.5;break;case".":i*=1.5;break;case"!":s=1;break;case",":s=.25}}return u(),t.shift(),t}function P(e,t){for(var n=0;n<e.length;n++)e[n][0]+=t}function H(e,t){out=[];for(it=0;it<e;it++)out=out.concat(t);return out}function B(e){var t=0;for(var n=0;n<e.length;n++)t+=e[n][1];return t}function j(e){var t=0;for(var n=0;n<e.length;n++){var r=B(e[n]);r>t&&(t=r)}return t}function F(){var e=H(2,D("2dad f*. d*.  fdf a3*.f2*.  a3f2a3 c.*a*.  f2a3f2 a3*.f2*.")),t=H(8,D("1d*r d* rd*r")),n=H(8,D("ddd  d!*rd*r")),r=H(8,D("1d*. 0d!*. 0d*r")),i=[e,t,r,n],s=j(i);console.log("music length=",s);var o=new C(s,.1,null,.4);return(new k(o,"sine",1,.8)).renderNotesPDV(e),(new k(o,"saw",1,.5)).renderNotesPDV(t),(new k(o,"snare",1,.8)).renderNotesPDV(n),(new k(o,"sine",1,.8)).renderNotesPDV(r),o.mixdown().asDataURI()}function ot(e){var t=e-$;$=e,V+=t,c(t),ut(t),at(t),ft(),W&&requestAnimFrame(ot)}function ut(e){var t=d(Q)*-0.01;nt++,nt>=tt.length&&(nt=0),rt+=2,rt>=tt.length&&(rt=0);if(m()<.003*e){var n={x:m(),y:-0.1};J.push(n),m()<.3&&J.push({x:n.x+.2*(m()-.5),y:n.y-.1*m()})}for(var r=0;r<J.length;r++){var n=J[r];n.y+=.01,n.x+=t,n.y>.85&&n.y<.95&&n.x>.5-et*2&&n.x<.5+et*2&&(K++,sfx.point.play(),K>13&&wt(),J.splice(r,1)),n.y>1.1&&J.splice(r,1)}music.ended&&Et()}function at(e){function r(e){q.beginPath(),q.moveTo(0,21),q.lineTo(14,58),q.bezierCurveTo(57,69,55,126,46,167),q.bezierCurveTo(151,195,253,124,264,-3),q.bezierCurveTo(301,23,359,101,348,206),q.bezierCurveTo(337,311,276,450,16*tt[nt]+276,450),q.lineTo(226,333),q.lineTo(e*12*tt[rt]+212,494),q.lineTo(172,378),q.lineTo(e*15*tt[rt]+132,526),q.lineTo(74,402),q.bezierCurveTo(74,402,38,431,36,486),q.bezierCurveTo(36,569,72,595,15*tt[nt]+106,680),q.lineTo(46,633),q.lineTo(-e*10*tt[rt]+24,683),q.lineTo(0,633),q.fill()}ct(),q.fillStyle="#444";for(var t=0;t<J.length;t++){var n=J[t];ht(q,n.x*U,n.y*z,z*et)}q.fillStyle="#000",q.save();var i=Z*U/700;q.translate(U/2,z*(1-.8*Z)),q.scale(i,i),q.rotate(Q),q.translate(0,-300),r(1),q.scale(-1,1),r(-1),q.restore()}function ft(){st&&st()}function lt(){q.setTransform(1,0,0,1,0,0),q.fillStyle="#090",q.fillRect(0,0,U,z)}function ct(){q.setTransform(1,0,0,1,0,0),q.globalCompositeOperation="source-atop",q.fillStyle="rgba(0,160,0, 0.5)",q.fillRect(0,0,U,z)}function ht(e,t,n,r){e.beginPath(),e.moveTo(t,n),e.arc(t,n,r,0,y),e.fill()}function pt(e,t,n,r){var i=Math.min(U/2,z)/60,s=U/2,o=z/2+t*i;q.fillStyle=n,q.font=e*i+"px bold terminus,terminal,monospace",q.textAlign="center",q.textBaseline="middle",q.fillText(r,s,o)}function dt(){W=X=!1,V=0,K=0,J=[],Q=0}function vt(){if(!X)return;W=!W,W?(st=null,music.play(),R=requestAnimFrame(ot)):(st=function(){pt(20,0,"yellow","PAUSED")},music.pause(),cancelAnimFrame(R))}function mt(){dt(),st=function(){pt(20,-15,"#bbb","LUCKY 13"),pt(8,0,"#bbb","COLLECT EXACTLY"),pt(8,8,"#bbb","13 POINTS TO WIN"),pt(10,20,"#bbb","SPACE BAR = START")}}function gt(){W||yt()}function yt(){lt(),dt(),W=X=!0,st=null,music.currentTime=0,music.currentTime=0,music.play(),R=requestAnimFrame(ot)}function bt(){W=!1}function wt(){bt(),st=function(){pt(20,-10,"#b00","BUSTED"),pt(14,10,"#b00","OVER 13"),dt(),music.pause(),sfx.lose.play()},cancelAnimFrame(R)}function Et(){bt(),K==13?st=function(){pt(40,0,"#fff","WIN"),dt()}:st=function(){pt(20,-10,"#b00","TIME UP"),pt(14,10,"#b00","SCORE: "+K),dt(),sfx.lose.play()},cancelAnimFrame(R)}function St(e,t){Q>-G&&(Q-=Y)}function xt(e,t){Q<G&&(Q+=Y)}function Tt(){window.requestAnimFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame;if(!window.requestAnimFrame)return;window.cancelAnimFrame=window.cancelAnimationFrame||window.webkitCancelAnimationFrame||window.mozCancelAnimationFrame||window.oCancelAnimationFrame||window.msCancelAnimationFrame,I=document.getElementById("canvas"),q=I.getContext("2d"),mt(),onresize()}var e={},t={},n=[],h=Math.floor,p=Math.pow,d=Math.sin,v=Math.log,m=Math.random,g=Math.PI,y=Math.PI*2,b=Math.E,w=44100,E=16,S=E/8,x=p(2,E)-1,T={"qc-meantone":[1,1.0449,1.118,1.1963,1.25,1.3375,1.3975,1.4953,1.5625,1.6719,1.7889,1.8692]},C=function(e,t,n,r){this.voices=[],this.seconds=e,this.noteLength=t||.25,this.temperamentName=n||Object.keys(T)[0],this.volume=r||1;var i=T[this.temperamentName];this.tuning=[];var s=55;for(var o=0;o<6;o++){for(var u=0;u<12;u++)this.tuning.push(s*i[u]);s*=2}};C.prototype=Object.create(Object.prototype),C.prototype.mixdown=function(){var e=this.voices.length,t=new k(this);console.log("mixdown",e,"voices",t.nSamples,"samples");var n=[];for(var r=0;r<=e;r++)n.push(new Int16Array(this.voices[r].w,44));console.log(n);for(var r=0;r<t.nSamples;r++){var i=0;for(var s=0;s<e;s++)i+=n[s][r];n[e][r]=i/e}return t};var k=function(e,t,n,r){this.parent=e,e.voices.push(this),this.waveform=t||"saw",this.noteLength=n||e.noteLength,this.volume=(r||1)*e.volume,this.seconds=e.seconds,this.nSamples=this.seconds*w,this.audioLength=this.nSamples*S,this.byteLength=44+this.audioLength,this.w=new ArrayBuffer(this.byteLength),this.wb=new Uint8Array(this.w),this.ww=new DataView(this.w),this.pos=0,this.ds("RIFF"),this.d4(this.byteLength-8),this.ds("WAVE"),this.ds("fmt "),this.d4(16),this.d2(1),this.d2(1),this.d4(w),this.d4(w*S),this.d2(S),this.d2(E),this.ds("data"),this.d4(this.audioLength)};k.prototype=Object.create(Object.prototype),k.prototype.d1=function(e){this.ww.setUint8(this.pos,e),this.pos+=1},k.prototype.d2=function(e){this.ww.setUint16(this.pos,e,!0),this.pos+=2},k.prototype.d4=function(e){this.ww.setUint32(this.pos,e,!0),this.pos+=4},k.prototype.ds=function(e){for(var t=0;t<e.length;t++)this.ww.setUint8(this.pos++,e.charCodeAt(t))},k.prototype.renderNotes=function(e){for(var t=0;t<e.length;t++){var n=e[t],r=this.noteLength,i=.2;if(n==null)this.rest(r);else switch(this.waveform){case"saw":this.sawWave(this.parent.tuning[n],r,i);break;case"sine":this.sineWave(this.parent.tuning[n],r,i);break;case"square":this.squareWave(this.parent.tuning[n],r,i);break;case"snare":this.snareWave(this.parent.tuning[n],r,i)}}},k.prototype.renderNotesPDV=function(e){for(var t=0;t<e.length;t++){var n=e[t],r=n[0],i=n[1],s=n[2]*this.volume;if(s==0)this.rest(i);else switch(this.waveform){case"saw":this.sawWave(this.parent.tuning[r],i,s);break;case"sine":this.sineWave(this.parent.tuning[r],i,s);break;case"square":this.squareWave(this.parent.tuning[r],i,s);break;case"snare":this.snareWave(this.parent.tuning[r],i,s)}}},k.prototype.rest=function(e){var t=0,n=h(w*e);for(var r=0;r<n;r++)this.d2(t)},k.prototype.squareWave=function(e,t,n){var r=[],i=h(w/e/2);for(var s=0;s<i;s++)r.push(N(0));for(var s=0;s<i;s++)r.push(N(n));this.renderWave(r,t)},k.prototype.renderWave=function(e,t){var n=w*t/e.length,r=h(n);for(var i=r;i>0;i--)for(var s=0;s<e.length;s++)this.d2(e[s]);var o=h((n-r)*e.length);this.rest(o/w)},k.prototype.sawWave=function(e,t,n){var r=[],i=h(w/e);for(var s=0;s<i;s++){var o=n*s/i-n/2;r.push(N(o))}this.renderWave(r,t)},k.prototype.sineWave=function(e,t,n){var r=[],i=h(w/e),s=y/i;for(var o=0;o<i;o++){var u=d(o*s)*n;r.push(N(u))}this.renderWave(r,t)},k.prototype.snareWave=function(e,t,n){function i(e){return p(1-e*(1/r),2)}var r=h(w*t);for(var s=0;s<r;s++){var o=m()*i(s)*n;this.d2(N(o))}},k.prototype.asDataURI=function(){strbuf="";for(var e=0;e<this.wb.length;e++)strbuf+=String.fromCharCode(this.wb[e]);return"data:audio/wav;base64,"+escape(btoa(strbuf))};var O=3,M=.15,_=.5;window.onload=function(){u(),f(80,vt),f(81,bt),f(27,bt),f(32,gt),l(37,St),l(39,xt),l(90,St),l(88,xt),A(),Tt()};var I,q,R,U,z,W,X,V,$=0,J,K,Q,G=.7,Y=.04,Z=.15,et=.015,tt=[],nt=0,rt=5;for(var it=0;it<Math.PI*2;it+=Math.PI/15)tt.push(d(it));var st=null;window.onresize=function(){U=window.innerWidth-40,z=window.innerHeight-2*I.offsetTop,U=Math.min(U,z*4/3),I.width=U,I.height=z,W||(lt(),X&&at(0),ft())};