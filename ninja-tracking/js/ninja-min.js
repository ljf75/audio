(function(e){function n(e,n){this.x=e[0],this.y=210,this.clockwise=this.x<t.CANVAS_WIDTH/2?1:-1,this.speedX=e[1],this.speedY=e[2],this.bomb=n,this.image=n?"images/bomb.png":"images/ninja.png",this.rotation=0,this.height=30,this.width=n?41:32,this.tick=1}var t={CANVAS_HEIGHT:240,CANVAS_WIDTH:320,GRAVITY:.001,MAX_WAVES:5,ROTATION_ANGLE:Math.PI/12,TRACKING_COLOR:"magenta",POSITIONS:[[20,5,7],[30,4,8],[40,3,9],[50,1,5],[100,2,10],[140,1,9],[150,3,9],[65,1.5,8.3],[82,7.5,2],[155,.7,9.4],[94,4.3,4],[105,3.8,7.6],[5,2.7,7.8],[12,7,7]]};n.prototype.move=function(){this.x+=this.speedX*this.clockwise,this.y-=this.speedY-this.speedY*t.GRAVITY*Math.pow(this.tick,2),this.tick++},n.prototype.render=function(){var e=this.x+this.width/2,t=this.y+this.height/2;context.save(),context.translate(e,t),context.rotate(this.rotation),context.translate(-1*e,-1*t);var n=new Image;n.src=this.image,context.drawImage(n,this.x,this.y),context.restore()},n.prototype.rotate=function(){this.rotation=this.rotation+t.ROTATION_ANGLE*this.clockwise};var r={drawSegments:[],fruits:[],context:null,intervalId:0,finished:!1,wave:0,score:0,init:function(){var e=this,n=(new tracking.VideoCamera).hide().render().renderVideoCanvas();context=n.canvas.context,n.track({type:"color",color:t.TRACKING_COLOR,onFound:function(t){e.drawSegments.push(t.x,t.y,(new Date).getTime())},onNotFound:function(){}}),e.loop(),e.intervalId=setInterval(e.fruitWave,5e3)},checkCollision:function(e){var t=r,n=t.drawSegments.length,i=t.drawSegments[n-3],s=t.drawSegments[n-2];return i>e.x&&i<e.x+e.width&&s>e.y&&s<e.y+e.height?!0:!1},gameOver:function(){var e=r;context.save(),context.scale(-1,1),context.textAlign="center",context.fillStyle="red",context.font="20pt impact",context.fillText("game over",-t.CANVAS_WIDTH/2,t.CANVAS_HEIGHT/2),context.fillText(r.score+" points",-t.CANVAS_WIDTH/2,t.CANVAS_HEIGHT/2+30),context.restore()},renderFruits:function(){var e=r,t=e.fruits.slice(0);for(var n=0,i=e.fruits.length;n<i;n++){var s=e.fruits[n];if(e.drawSegments.length>0&&e.checkCollision(s)){s.bomb&&e.score>0?e.score--:e.score++,t.splice(n,1);continue}s.render(),s.rotate(),s.move()}e.fruits=t},renderScore:function(){var e=r;context.save(),context.scale(-1,1),context.fillStyle="red",context.font="12pt sans-serif",context.fillText("score "+r.score,-70,230),context.restore()},renderTrail:function(){var e=r,t=(new Date).getTime(),n=0;for(var i=0,s=e.drawSegments.length;i<s;i+=3){var o=t-e.drawSegments[i+2],u=1-o/1e3;u>0&&u<=1?(context.save(),context.fillStyle="rgba(255,255,255,"+u+")",context.fillRect(e.drawSegments[i],e.drawSegments[i+1],4,4),context.restore()):n+=3}n>0&&e.drawSegments.splice(0,n)},fruitWave:function(){var e=r,i=t.POSITIONS.slice(0);e.fruits=[];for(var s=0;s<4;s++){var o=Math.floor(Math.random()*i.length),u=i[o],a=Math.round(Math.random()),f=u[0];a&&(f=t.CANVAS_WIDTH-f);var l=!1;s==0&&(l=!0);var c=new n([f,u[1],u[2]],l);e.fruits.push(c),i.splice(o,1)}e.wave++,r.wave>=t.MAX_WAVES&&(clearInterval(e.intervalId),setTimeout(function(){e.finished=!0},4e3))},loop:function(){var e=r;e.finished?e.gameOver():(e.renderTrail(),e.renderFruits(),e.renderScore()),requestAnimationFrame(e.loop)}};e.game=r})(window);