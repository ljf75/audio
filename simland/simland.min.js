s=document.createElement('style');s.innerHTML=c.replace(/-X([^X]+)X-/g,'-webkit-$1 -moz-$1 -o-$1 $1').replace(/-@([^@]+)@-/g,'@-webkit-$1 @-moz-$1 @-o-$1 @$1').replace(/bg/g,'background').replace(/}/g,'}\n');document.head.appendChild(s);c=null;
(function(E){function makeEl(a,b){var c=document.createElement(a);for(att in b){if(att=='p')b.p.appendChild(c);else{if(att=='t')c.innerHTML=b.t;else c.setAttribute(att,b[att])}}return c}if(!console)console={log:function(){}};function arrayRand(a){return a.sort(function(){return Math.random()-0.5})}function round2(a){return Math.round(a*100)/100}function round2str(a){return round2(a).toString().replace(/(\...).*/,'$1')}months='Jan Feb Mar Apr May Jun Jul Aug Sep Oct Nov Dec'.split(' ');E.SimLand=function SimLand(a,b){this.landSize=b;this.date=[2000,0];this.monthSecsDelay=10;this.money=1000;this.taxes={individual:0.2,commerce:5,industry:7,farming:2};this.cache={};this.g=10;this.f=20;this.autoShowSadnessReport=true;this.baseEl=document.getElementById(a);this.baseEl.style.width=(b*40)+'px';this.baseEl.style.height=(b*24+50)+'px';this.landEl=makeEl('div',{class:'visibleLand landDimention',p:this.baseEl});this.eventCatcher=makeEl('div',{class:'eventCatcher landDimention',p:this.baseEl,style:'z-index:'+(b+10)});this.landEl.style.width=this.eventCatcher.style.width=b*20+'px';this.landEl.style.height=this.eventCatcher.style.height=b*20+'px';this.landEl.style.left=this.eventCatcher.style.left=(b*10)+'px';this.landEl.style.top=this.eventCatcher.style.top=(b*2+50)+'px';this.s=[];for(var x=0;x<b;x++){this.s[x]=[];for(var y=0;y<b;y++){this.s[x][y]=new Square(this,x,y);if(Math.random()<0.4)this.s[x][y].add('tree',true)}}makeControls(this);this.setTool('pointer');createInitialCity(this,Math.floor(b/2),Math.floor(b/2));this.cache={};this.updateStatus();var c=this;this.ticTimeout=setTimeout(function(){c.tic()},this.monthSecsDelay*1000)};SimLand.prototype.tic=function(){try{this.date[1]++;if(this.date[1]>11){this.date[1]=0;this.date[0]++}this.collectTaxes();for(var x=0;x<this.landSize;x++){for(var y=0;y<this.landSize;y++){var a=this.s[x][y];var b=this.calcProductionFor(a);this.money-=b.consumption.money;this.g+=b.goods-b.consumption.goods;this.f+=b.food-b.consumption.food}}this.g=Math.round(this.g*9)/10;this.f=Math.round(this.f*8)/10;if(this.g<0)this.g=0;if(this.f<0)this.f=0;this.privateInitiativeNewBuildings();this.bornAndDie();this.moveDwellers();this.somethingWasDestroyed()}catch(e){console.log(e.stack,e)}this.cache={};this.updateStatus();var c=this;if(this.calcHappiness()==0)return this.sadGameOver();if(this.countPopulation()==0)return this.popGameOver();this.ticTimeout=setTimeout(function(){c.tic()},this.monthSecsDelay*1000);if(this.calcHappiness()<0.25&&this.autoShowSadnessReport)this.displaySadnessReport()};SimLand.prototype.moveDwellers=function(){var c=this.getSquareByType('house').sort(function(a,b){return a.dwellers-b.dwellers});c[0].dwellers++;c[c.length-1].dwellers--};SimLand.prototype.somethingWasDestroyed=function(){var b=(this.date[0]-2005)/100;if(b>0.5)b=0.5;if(Math.random()<b){var c=this.buildings();this.getSquareByType('road').forEach(function(a){c.push(a)});var d=arrayRand(c)[0];if(d){var e=F[d.type].fName;d.clear(true);var f=createWindow('"Shit happens"&trade;');makeEl('div',{p:f,t:'<p><b>Oh my ...!!!</b></p><p>The '+e+' at lat '+d.getLat()+', lon '+d.getLon()+' was destructed.</p>'})}}};SimLand.prototype.privateInitiativeNewBuildings=function(){var b=this.countPopulation();var c=arrayRand(this.getSquareByType('house'));if(b>c.length*5){var d=arrayRand(this.getSquareByType('resid'));if(d[0])d[0].add('house');if(b>c.length*6&&d[1])d[1].add('house',true)}if((b+this.calcRequiredGoodsOrFood())>this.f){var e=arrayRand(this.getSquareByType('country'));var f=((Math.random()<0.3)?'silo':'farm');if(e[0])e[0].add(f);if(b>this.f*1.5&&e[1])e[1].add(f,true)}var g=this.getSquareByType('shopping');var h=this,shoppWorkers=0,shoppJobs=0;g.forEach(function(a){shoppWorkers+=h.calcWorkersFor(a);shoppJobs+=F.shopping.employs});if((shoppWorkers/shoppJobs)>0.8){var i=arrayRand(this.getSquareByType('commerce'));if(i[0])i[0].add('shopping');if((shoppWorkers/shoppJobs)>0.9&&i[1])i[1].add('shopping',true)}var j=this.calcRequiredGoods()+this.calcRequiredGoodsOrFood();var h=this,prodGoods=0,factoryWorkers=0,factoryJobs=0;this.getSquareByType('factory').forEach(function(a){prodGoods+=h.calcProductionFor(a).goods;factoryWorkers+=h.calcWorkersFor(a);factoryJobs+=F.factory.employs});if((factoryWorkers/factoryJobs)>0.8&&j>prodGoods){var i=arrayRand(this.getSquareByType('industry'));if(i[0])i[0].add('factory',true)}};SimLand.prototype.bornAndDie=function(){var b=this.countPopulation();var c=this.getSquareByType('house');var d=this.getSquareByType('hospital').length/b;if(d>0.01)d=0.01;var e=this.calcPollution();var f=0.003+d;if(b<50)f*=3;if(b<100)f*=3;if(b<150)f*=2;if(b<200)f*=1.5;if(b<250)f*=1.5;if(b<300)f*=1.5;var g=Math.round(b*f+Math.random());var h=0.002-d+e/1000;var i=Math.round(b*h+Math.random()*0.7);if((b+g-i)>c.length*10)g=c.length*10-b+i;var j=this;console.log(this.date,'Die:'+i,'Born:'+g);arrayRand(c).forEach(function(a){if(a.dwellers>1&&i>0){a.dwellers--;i--}});arrayRand(c).forEach(function(a){if(a.dwellers<10&&g>0){a.dwellers++;g--}})};SimLand.prototype.collectTaxes=function(){var a=0;for(var x=0;x<this.landSize;x++){for(var y=0;y<this.landSize;y++){var b=this.s[x][y];var c=F[b.type];if(c&&c.taxType){var d=this.taxes[c.taxType];if(c.taxType=='individual'){a+=d*b.dwellers}else{if(c.taxType=='commerce'){var e=this.calcWorkersFor(b);var f=c.employs;a+=d*e/f}else{var g=(c.goods?'goods':'food');var h=this.calcProductionFor(b)[g];var i=c[g];a+=d*h/i}}}}}a=round2(a);console.log(this.date,'Total tax earn: '+a);this.money+=a};SimLand.prototype.calcWorkersFor=function(a){var b='workersFor-'+a.x+'-'+a.y;if(!this.cache[b]){var c=F[a.type];var d=this.countPopulation();var e=0;var f=0;for(var x=0;x<this.landSize;x++){for(var y=0;y<this.landSize;y++){var g=this.s[x][y];var h=F[g.type];if(h&&h.employs){e+=h.employs;if(h.priorityJob)f+=h.employs}}}if(d*0.8>e){this.cache[b]=c.employs}else{var i=e-f;if(d*0.8>f*2){if(c.priorityJob)this.cache[b]=c.employs;else{var x=(d*0.8)-f;this.cache[b]=Math.floor(c.employs*(x/i))}}else{this.cache[b]=Math.round(Math.random())+Math.round(c.employs*(d/e))}}}return this.cache[b]};SimLand.prototype.calcRequiredPower=function(){if(!this.cache.requiredPower){this.cache.requiredPower=0;for(var x=0;x<this.landSize;x++){for(var y=0;y<this.landSize;y++){var a=this.s[x][y];var b=F[a.type];if(b&&b.needPower){this.cache.requiredPower+=b.needPower}}}}return this.cache.requiredPower};SimLand.prototype.calcProducedPower=function(){if(!this.cache.producedPower){this.cache.producedPower=0;for(var x=0;x<this.landSize;x++){for(var y=0;y<this.landSize;y++){var a=this.s[x][y];var b=F[a.type];if(b&&b.power){this.cache.producedPower+=b.power}}}}return this.cache.producedPower};SimLand.prototype.calcRequiredGoods=function(){if(!this.cache.requiredGoods){this.cache.requiredGoods=0;for(var x=0;x<this.landSize;x++){for(var y=0;y<this.landSize;y++){var a=this.s[x][y];var b=F[a.type];if(b&&b.needGoods){this.cache.requiredGoods+=b.needGoods}}}}return this.cache.requiredGoods};SimLand.prototype.calcRequiredGoodsOrFood=function(){if(!this.cache.requiredGoodsOrFood){this.cache.requiredGoodsOrFood=0;for(var x=0;x<this.landSize;x++){for(var y=0;y<this.landSize;y++){var a=this.s[x][y];var b=F[a.type];if(b&&b.needGoodsOrFood){this.cache.requiredGoodsOrFood+=b.needGoodsOrFood}}}}return this.cache.requiredGoodsOrFood};SimLand.prototype.calcProductionFor=function(a){var b='productionFor-'+a.x+'-'+a.y;var c={food:0,goods:0,money:0};if(!this.cache[b]){var d='';var e=F[a.type];if(!e||e.type=='tree'){this.cache[b]={report:'',goods:0,food:0,consumption:c};return this.cache[b]}if(a.type=='house'){var f=this.countPopulation();var g=this.f/f;if(g>1)g=1;var h=Math.round(a.dwellers*g*10)/10;d+='Receiving '+h+' food units, '+Math.round(g*100)+'% of the required.';c.food=h}else{var i=this.calcWorkersFor(a);var j=Math.round(100*i/e.employs);d+='Employing '+i+' workers, '+j+'% of the required.'}if(e.needPower){var k=this.calcRequiredPower();var l=this.calcProducedPower();var m=Math.round(100*l/k);if(m>100)m=100;d+='<br>Receiving '+m+'% of the required power.'}var n=100,goods=0,food=0;if(e.needGoods||e.needGoodsOrFood){var o=(e.needGoods?'needGoods':'needGoodsOrFood');var p=this.calcRequiredGoods();n=Math.round(100*this.g/p);c.goods=e[o]*n/100;if(n<3)n=3;n+=(100-n)/3;if(e.needGoodsOrFood&&n<100){var q=this.calcRequiredGoodsOrFood();var f=this.countPopulation();var g=Math.round(100*(this.f-f)/q);if(g<0)g=0;g=(((100-n)<g)?100-n:g);c.food=e.needGoodsOrFood*g/100;if(n<4&&g<3)g=3;n+=g;if(n>100)n=100}var r=(e.needGoodsOrFood?'goods or food':'goods');d+='<br>Receiving '+n+'% of the required '+r+'.'}if(e.goods){goods=e.goods*(j*m*n)/(100*100*10);goods=Math.round(goods)/10;var s=Math.round(100*goods/e.goods);d+='<br>Produceing '+goods+' goods. ('+s+'% of the potential)'}if(e.food){food=e.food*(j*m*n)/(100*100*10);food=Math.round(food)/10;var s=Math.round(100*food/e.food);food+=(100-s)*e.food/200;s=Math.round(100*food/e.food);d+='<br>Produceing '+food+' food. ('+s+'% of the potential)'}if(e.maintenance){c.money=e.maintenance;d+='<br>Maintenance costs $'+e.maintenance}if(e.power)d+='<br>Power generation: '+e.power+'⚡';if(e.pollution)d+='<br>Pollution: '+e.pollution+'uP';this.cache[b]={report:d,goods:goods,food:food,consumption:c}}return this.cache[b]};function createInitialCity(a,x,y){a.s[x-1][y].add('road',true);a.s[x][y].add('road',true);a.s[x+1][y].add('road',true);a.s[x-1][y-1].add('farm',true);a.s[x][y-1].add('house',true).dwellers=5;a.s[x+1][y-1].add('house',true).dwellers=5;a.s[x-1][y-2].add('house',true).dwellers=5;a.s[x][y-2].add('house',true).dwellers=5;a.s[x+1][y-2].add('house',true).dwellers=5;a.s[x-1][y+1].add('factory',true);a.s[x][y+1].add('shopping',true);a.s[x+1][y+1].add('powerCoal',true)}function makeControls(b){var c=makeEl('div',{class:'ctrlBoxBorder',p:b.baseEl.parentNode,style:'z-index:'+(b.landSize+20)});c=makeEl('div',{class:'ctrlBox',p:c});var d='opacity-bt-'+Math.random()+'-';var e='onclick="this.parentNode.setObjOpct(this.value)"';var f=makeEl('div',{class:'opt gameObjOpacity',p:c,t:'Objects opacity:<br><input type="radio" name="'+d+'GOO" id="'+d+'GOO-O" value="opaque" '+e+' checked><label for="'+d+'GOO-O">Opaque</label><input type="radio" name="'+d+'GOO" id="'+d+'GOO-T" value="translucent" '+e+'><label for="'+d+'GOO-T">Translucent</label><input type="radio" name="'+d+'GOO" id="'+d+'GOO-G" value="glass" '+e+'><label for="'+d+'GOO-G">Glass</label>'});b.baseEl.className+=' objOpacity-opaque';f.setObjOpct=function(a){b.baseEl.className=b.baseEl.className.replace(/objOpacity-[^ ]+/,'objOpacity-'+a)};var e='onclick="this.parentNode.setDisplayType(this.value)"';var g=makeEl('div',{class:'opt squareTypeView',p:c,t:'Display square type:<br><input type="radio" name="'+d+'DST" id="'+d+'DST-N" value="none" '+e+'><label for="'+d+'DST-N">None</label><input type="radio" name="'+d+'DST" id="'+d+'DST-C" value="color" '+e+' checked><label for="'+d+'DST-C">Square color</label>'});b.baseEl.className+=' displaySquareType-color';g.setDisplayType=function(a){b.baseEl.className=b.baseEl.className.replace(/displaySquareType-[^ ]+/,'displaySquareType-'+a)};var e='onclick="this.parentNode.setDelay(this.value)"';var h=makeEl('div',{class:'opt gameMonthDelay',p:c,t:'Game speed:<br><input type="radio" name="'+d+'GMD" id="'+d+'GMD-1" value="30" '+e+'><label for="'+d+'GMD-1">Turtle</label><input type="radio" name="'+d+'GMD" id="'+d+'GMD-2" value="10" '+e+' checked><label for="'+d+'GMD-2">Lhama</label><input type="radio" name="'+d+'GMD" id="'+d+'GMD-3" value="3" '+e+'><label for="'+d+'GMD-3">Puma</label>'});h.setDelay=function(a){b.monthSecsDelay=parseInt(a);clearTimeout(b.ticTimeout);b.ticTimeout=setTimeout(function(){b.tic()},b.monthSecsDelay*1000)};var e='onclick="this.parentNode.setShowInfoBox(this.checked)"';var i=makeEl('div',{class:'opt showInfoBox',p:c,t:'<input type="checkbox" id="'+d+'SIB" '+e+' checked><label for="'+d+'SIB">Show Info Box</label>'});i.setShowInfoBox=function(a){b.infoBox.style.display=(a?'block':'none')};var j=makeEl('div',{class:'bt openTaxes',p:c});var k=makeEl('button',{p:j,t:'Open taxes dialog'});k.onclick=function(){openTaxesDialog(b)};var l=makeEl('div',{class:'bt openSadnessReport',p:c});var m=makeEl('button',{p:l,t:'Open (happy|sad)ness report'});m.onclick=function(){b.displaySadnessReport()};var p=b.buildOptsBox=makeEl('div',{class:'buildOptsBoxBorder',p:b.baseEl.parentNode,style:'z-index:'+(b.landSize+20)});p=makeEl('div',{class:'buildOptsBox',p:p});for(var q in F){var r=F[q];if(!r.p){var s='';if(r.cost)s+=' - Cost: $'+r.cost;var t=makeEl('div',{p:p,title:r.hint+s,t:r.fName});r.menuItem=t;t.toolName=q;t.onclick=function(){b.setTool(this.toolName)}}}var u=b.infoBox=makeEl('div',{class:'infoBox',p:b.baseEl.parentNode,style:'z-index:'+(b.landSize+15),t:'No info'});b.baseEl.onmouseover=function(){b.infoBox.innerHTML='Nothing'};var v=b.statusBox=makeEl('div',{class:'status',p:b.baseEl.parentNode,style:'z-index:'+(b.landSize+25),t:'No status'})}var F={pointer:{fName:'Pointer',hint:'Select and see things'},clear:{fName:'Clear',hint:'Destroy and clear square definition',cost:10},tree:{fName:'Trees',hint:'Plant trees',pollution:-15,desc:'So green, so clean...',cost:10},road:{fName:'Road',hint:'Connect places and enable transportation',cost:50,maintenance:0.1,needPower:1},country:{fName:'Countryside',hint:'For food production',cost:5},power:{fName:'Power Plant',hint:'Select a kind of power generator'},resid:{fName:'Residential Area',hint:'Where to leave',cost:20},house:{fName:'House',hint:'Home, Sweet Home',p:'resid',pollution:10,needPower:1,lives:10,taxType:'individual'},commerce:{fName:'Commercial Area',hint:'Where to buy and trade',cost:20},shopping:{fName:'Shopping Center',hint:'Where to buy and trade',pollution:10,needPower:5,employs:20,serves:200,needGoodsOrFood:100,p:'commerce',taxType:'commerce'},industry:{fName:'Industrial Area',hint:'Where to produce',cost:20},factory:{fName:'Factory',hint:'Nothing is lost or created, all is transformed',pollution:100,needPower:10,employs:16,goods:100,needGoodsOrFood:100,p:'industry',taxType:'industry'},pubServ:{fName:'Public Service',hint:'Organize, protect and help people'},farm:{fName:'Farm',hint:'For food production',p:'country',pollution:1,needPower:5,needGoods:10,food:50,employs:2,taxType:'farming'},silo:{fName:'Silo',hint:'For food storage',p:'country',needPower:1,needGoods:5,food:50,employs:2,taxType:'farming'},hospital:{fName:'Hospital',hint:'Medical attention',p:'pubServ',cost:1000,maintenance:10,pollution:50,needPower:1,employs:20,priorityJob:true,serves:60,needGoods:150},school:{fName:'School',hint:'To grow up brains',p:'pubServ',cost:500,maintenance:10,pollution:20,needPower:1,employs:15,priorityJob:true,serves:100,needGoods:100},police:{fName:'Police',hint:'Protect the people',p:'pubServ',cost:1000,maintenance:5,pollution:30,needPower:1,employs:15,priorityJob:true,needGoods:60},sport:{fName:'Sports Court',hint:'Heath and Fun',p:'pubServ',cost:100,maintenance:0.1,needPower:1,employs:1,serves:100,needGoods:1},powerCoal:{fName:'Coal Power Plant',hint:'Cheap pollution plant',p:'power',cost:1000,maintenance:8,pollution:500,power:100,employs:15,priorityJob:true,needGoods:100},powerWind:{fName:'Wind Power Plant',hint:'Sustainable power plant',p:'power',cost:3000,maintenance:3,pollution:1,power:50,employs:5,priorityJob:true,needGoods:10},};for(type in F){if(F[type].employs)F[type].info=function(a){var b=a.game.calcProductionFor(a);return b.report}}F.house.info=function(a){var b='There is '+a.dwellers+' persons living here.';if(a.dwellers==F.house.lives)b+=' (Maximum!)';b+='<br>'+a.game.calcProductionFor(a).report;return b};F.power.onSelect=function(a){var b=createWindow('Select a Power Plant');b.className+=' powerPlantSelect';for(var c in F){var d=F[c];if(d.p=='power'){var e=makeEl('div',{p:b,class:'option',t:'<b>'+d.fName+'</b> &nbsp; <small>($'+d.cost+')</small><br>'+d.hint+'<br>Generates '+d.power+'⚡'});e.buildingName=c;e.onclick=function(){a.setTool(this.buildingName);b.close()}}}};F.pubServ.onSelect=function(a){var b=createWindow('Select a Public Service');b.className+=' pubServSelect';for(var c in F){var d=F[c];if(d.p=='pubServ'){var e=makeEl('div',{p:b,class:'option',t:'<b>'+d.fName+'</b> &nbsp; <small>($'+d.cost+')</small><br>'+d.hint+'<br>Maintenance: $'+d.maintenance});e.buildingName=c;e.onclick=function(){a.setTool(this.buildingName);b.close()}}}};function createWindow(a,b){var c=makeEl('div',{class:'blackBlock',p:document.body,style:'z-index:'+(9999)});var d=makeEl('div',{class:'window',p:c});makeEl('h2',{class:'title',p:d,t:a});var e=makeEl('div',{class:'windowClose',p:d,t:'✖'});d.close=function(){document.body.removeChild(c);if(b)b()};e.onclick=function(){d.close()};return d}function openTaxesDialog(b){var c=createWindow('Set Taxes');makeEl('div',{p:c,t:'Individual: <input size="3">'});makeEl('div',{p:c,t:'Commerce: <input size="3">'});makeEl('div',{p:c,t:'Industry: <input size="3">'});makeEl('div',{p:c,t:'Farming: <input size="3">'});var d=c.getElementsByTagName('input');var e={};d[0].value=e.individual=b.taxes.individual;d[1].value=e.commerce=b.taxes.commerce;d[2].value=e.industry=b.taxes.industry;d[3].value=e.farming=b.taxes.farming;makeEl('button',{p:c,t:'Ok',style:'font-weight:bold'}).onclick=function(){b.taxes.individual=parseFloat(d[0].value);b.taxes.commerce=parseFloat(d[1].value);b.taxes.industry=parseFloat(d[2].value);b.taxes.farming=parseFloat(d[3].value);for(var a in b.taxes){if(isNaN(b.taxes[a])){b.taxes[a]=e[a];alert('The new '+a+' value was not a number. Restoring original.')}}c.close()};makeEl('button',{p:c,t:'Cancel'}).onclick=function(){c.close()}}var G=null;SimLand.prototype.setTool=function(a){if(G)G.className='';var b=F[a].menuItem;if(!b)b=F[F[a].p].menuItem;if(b){G=b;G.className='selected'}this.currentTool=a;this.updateStatus();if(F[a].onSelect)F[a].onSelect(this)};SimLand.prototype.updateStatus=function(){this.statusBox.innerHTML='Active tool: <b>'+F[this.currentTool].fName+'</b> &nbsp; &nbsp; Money: <b>$'+round2str(this.money)+'</b> &nbsp; &nbsp; Date: <b>'+this.date[0]+'/'+months[this.date[1]]+'</b> &nbsp; &nbsp; Population: <b>'+this.countPopulation()+'</b> &nbsp; &nbsp; Pollution: <b>'+this.calcPollution()+'</b> &nbsp; &nbsp; <div id="happiness">Happiness: <b>'+this.calcHappiness(true)+'</b></div>'};SimLand.prototype.countPopulation=function(){if(!this.cache.population){this.cache.population=0;var b=this;this.getSquareByType('house').forEach(function(a){b.cache.population+=a.dwellers})}return this.cache.population};SimLand.prototype.calcPollution=function(){if(!this.cache.pollution){var a=0;for(var x=0;x<this.landSize;x++){for(var y=0;y<this.landSize;y++){var b=F[this.s[x][y].type];if(b&&b.pollution)a+=b.pollution}}this.cache.pollution=(a<0)?0:a}return this.cache.pollution};SimLand.prototype.buildings=function(){var a=[];for(var x=0;x<this.landSize;x++){for(var y=0;y<this.landSize;y++){var b=F[this.s[x][y].type];if(b&&b.p){a.push(this.s[x][y])}}}return a};SimLand.prototype.buildingsWhitoutRoad=function(){var e=0;var f=this;this.buildings().forEach(function(c){var d=false;[[c.x-1,c.y],[c.x+1,c.y],[c.x,c.y-1],[c.x,c.y+1]].forEach(function(a){var b=null;if(f.s[a[0]])b=f.s[a[0]][a[1]];if(b&&b.type=='road')d=true});if(!d)e++});return e};SimLand.prototype.calcHappiness=function(b){if(!this.cache.happiness){this.sadnessReport=[];var c=round2(this.calcPollution()/2000);this.sadnessReport.push(['pollution',c]);var d=round2(this.buildingsWhitoutRoad()/(this.buildings().length*2));if(this.buildings().length==0)d=0;this.sadnessReport.push(['transportation',d]);var e=0;for(var f in this.taxes){e+=this.taxes[f]}var g=round2((e-10)/20);this.sadnessReport.push(['taxes',g]);var h=this.countPopulation();var i=round2((1-this.f/h)/2);if(i<0)i=0;this.sadnessReport.push(['food production',i]);var j=(1-this.g/h)/6;if(h<150)j/=(150-h);if(j<0)j=0;j=round2(j);this.sadnessReport.push(['goods production',j]);var k=this.getSquareByType('house').length;var l=round2(((h/k)-4)/30);if(k==0)l=0.9;this.sadnessReport.push(['residential area size',l]);var m=this.getSquareByType('hospital').length;var n=(1-(m/(h/200)))/1.5;if(h<300)n/=(300-h);n=round2(n);if(n<0)n=0;this.sadnessReport.push(['health service',n]);var o=this.getSquareByType('school').length;var p=(1-(o/(h/200)))/2;if(h<300)p/=(300-h);p=round2(p);if(p<0)p=0;this.sadnessReport.push(['educational level',p]);var q=this.getSquareByType('police').length;var r=200*p;var s=(1-(q/(h/(200-r))))/1.5;if(h<300)s/=(300-h);s=round2(s);if(s<0)s=0;this.sadnessReport.push(['criminality level',s]);var t=this.getSquareByType('sport').length;var u=(1-(t/(h/300)))/2;if(h<300)u/=(300-h);if(u<0)u=0;u=round2(u);this.sadnessReport.push(['sports promotion',u]);var v=this.getSquareByType('shopping');var w=v.length/(h/100);var x=this,workers=0,jobs=0;v.forEach(function(a){workers+=x.calcWorkersFor(a);jobs+=F.shopping.employs});var y=(1-(w/(jobs-workers)))/3;if(h<200)y/=(200-h);if(y<0)y=0;y=round2(y);this.sadnessReport.push(['commerce options',y]);var z=this.calcRequiredPower();var A=this.calcProducedPower();var B=(1-A/z)/2;if(B<0)B=0;B=round2(B);this.sadnessReport.push(['power production',B]);var C=1;this.sadnessReport.forEach(function(a){C-=a[1]});C=round2(C);if(C<0)C=0;if(C>1)C=1;console.log(this.date,'happiness:'+C,this.sadnessReport.join(' | '));this.cache.happiness=C}var D=['😫','😡','😠','😞','😐','😌','😊','😃','😄'];if(b){if(b=='faceOnly')return D[Math.round((D.length-1)*this.cache.happiness)];return this.cache.happiness+'<span>'+D[Math.round((D.length-1)*this.cache.happiness)]+'</span>'}else return this.cache.happiness};SimLand.prototype.displaySadnessReport=function(){var c=this.sadnessReport.sort(function(a,b){return b[1]-a[1]});var d=this.calcHappiness();var e=this.calcHappiness('faceOnly');clearTimeout(this.ticTimeout);var f=this;var g=(d<=0.5)?'Sadness Report':'Happiness Report';var h=createWindow(g,function(){if(!f.gameover)f.ticTimeout=setTimeout(function(){f.tic()},f.monthSecsDelay*1000)});var i='<div class="date">'+this.date[0]+'/'+months[this.date[1]]+'</div>';if(e=='😐')i+='<h2>The people is "poker faced"</h2>';else{if(d>0.5){if(d>=0.8)i+='<h2>The people is very happy!</h2>';else i+='<h2>The people is happy</h2>'}else{if(d<=0.1)i+='<h2>The people want to kill you!</h2>';else if(d<=0.2)i+='<h2>The people is very sad!</h2>';else i+='<h2>The people is sad</h2>'}}i+='<div class="face">'+e+'</div><ul>';c.forEach(function(a){if(a[1]==0)i+='<li><b>There is no problem with '+a[0]+'!</b> 😃</li>';else i+='<li><b>'+a[0]+'</b> is unacceptable for <b>'+round2str(a[1]*100)+'%</b> of the people.</li>'});i+='</ul>';var j=makeEl('div',{class:'sadnessReport',t:i,p:h});var k=makeEl('div',{class:'btAutoShow',p:j});var l='btAutoShow'+Math.random();var m=makeEl('input',{id:l,type:'checkbox',p:k});makeEl('label',{t:'Auto show this report when sadness is critical','for':l,p:k});m.checked=this.autoShowSadnessReport;m.onclick=function(){f.autoShowSadnessReport=this.checked}};SimLand.prototype.gameOver=function(a){this.setTool('pointer');this.gameover=true;this.buildOptsBox.style.display='none';var b=this;var c=createWindow('Game Over',function(){makeEl('div',{class:'gameover',t:'Game Over',p:b.baseEl})});makeEl('div',{class:'gameoverInfo',t:a,p:c})};SimLand.prototype.sadGameOver=function(){this.gameOver('<p>The people happiness become 0.</p><p>Your ass was kicked until your death.</p>')};SimLand.prototype.popGameOver=function(){this.gameOver('<p>All the people die.</p><p>Welcome to Zombie Town.</p>')};SimLand.prototype.getSquareByType=function(a){var b=[];for(var x=0;x<this.landSize;x++){for(var y=0;y<this.landSize;y++){if(this.s[x][y].type==a)b.push(this.s[x][y])}}return b};function Square(b,x,y){this.game=b;this.x=x;this.y=y;this.type='grass';var c=(((x*b.landSize+y)%2)==0?'odd':'even');var d=this.visibleEl=makeEl('div',{class:'s '+c,p:b.landEl,style:'z-index:'+(b.landSize-y)});var e=this.eventEl=makeEl('div',{class:'s',p:b.eventCatcher,style:'z-index:'+(b.landSize-y)});d.gameSquare=e.gameSquare=this;this.classNameOrig=d.className;d.className+=' grass';var f=this;e.onmouseover=function(a){f.onMouseOver();a.stopPropagation()};e.onmouseout=function(){f.onMouseOut()};e.onclick=function(){f.onClick()}}Square.prototype.getLat=function(){var a=Math.floor((this.x+1)-(this.game.landSize/2));if(a==0){return'0.0&deg;'}else{if(a<0)return Math.abs(a/10)+'&deg; North';else return(a/10)+'&deg; South'}};Square.prototype.getLon=function(){var a=Math.floor((this.y+1)-(this.game.landSize/2));if(a==0){return'0.0&deg;'}else{if(a<0)return Math.abs(a/10)+'&deg; West';else return(a/10)+'&deg; East'}};Square.prototype.onMouseOver=function(){this.visibleEl.className+=' hover';var a=this.type;var b='Nothing to see here';var c=F[this.type];if(c){b=(c.desc?c.desc:c.hint);a=c.fName;if(c.info)b+='<div>'+c.info(this)+'</div>'}this.game.infoBox.innerHTML='<div>Location: Lat '+this.getLat()+', Lon '+this.getLon()+'</div><div>Type: <b>'+a+'</b></div><div>'+b+'</div><div>Global goods stock: '+this.game.g+'</div><div>Global food stock: '+this.game.f+'</div>'};Square.prototype.onMouseOut=function(){this.visibleEl.className=this.classNameOrig+' '+this.type};Square.prototype.onClick=function(){if(this.game.currentTool=='clear'){this.clear();return}if(F[this.game.currentTool].add){if(this.type!='grass'&&this.type!='tree'){var a=createWindow('Replace building?');var b=F[this.type].fName;makeEl('p',{p:a,t:'This place has a "'+b+'".<br>Do you want to destroy it?'});var c=this;makeEl('button',{p:a,t:'Yes'}).onclick=function(){c.add(c.game.currentTool);a.close()};makeEl('button',{p:a,t:'No'}).onclick=function(){a.close()}}else{this.add(this.game.currentTool)}}};Square.prototype.clear=function(a){if(!a&&this.type!='grass'){if(this.game.money<F.clear.cost){alert('You can\'t pay for destruct and clear this area.\n($'+F.clear.cost+')');return false}this.game.money-=F.clear.cost}this.type='grass';this.visibleEl.className=this.classNameOrig+' '+this.type;while(this.visibleEl.firstChild)this.visibleEl.removeChild(this.visibleEl.firstChild);var b=this.game.s;var x=this.x,y=this.y;if(b[x-1]&&b[x-1][y]&&b[x-1][y].type=='road')F.road.update(b[x-1][y]);if(b[x+1]&&b[x+1][y]&&b[x+1][y].type=='road')F.road.update(b[x+1][y]);if(b[x][y-1]&&b[x][y-1].type=='road')F.road.update(b[x][y-1]);if(b[x][y+1]&&b[x][y+1].type=='road')F.road.update(b[x][y+1]);return true};Square.prototype.add=function(a,b){var c=F[a];if(!this.clear(b))return this;if(!b){if(c.cost){if(this.game.money<c.cost){alert('You can\'t pay for a '+c.fName+'.\n($'+c.cost+')');return}this.game.money-=c.cost;this.game.updateStatus()}}c.add(this);this.visibleEl.className=this.classNameOrig+' '+this.type;return this};F.tree.add=function(a){a.type='tree';var b=makeEl('div',{class:'gameObj tree',p:a.visibleEl});makeEl('div',{class:'piece tree1',p:b});makeEl('div',{class:'piece tree2',p:b});makeEl('div',{class:'piece tree3',p:b})};F.road.add=function(a){a.type='road';var b=makeEl('div',{class:'gameObj',p:a.visibleEl});makeEl('div',{class:'piece north',p:b});makeEl('div',{class:'piece south',p:b});makeEl('div',{class:'piece west',p:b});makeEl('div',{class:'piece east',p:b});var c=a.game.s;var x=a.x,y=a.y;this.update(a);if(c[x-1]&&c[x-1][y]&&c[x-1][y].type=='road')this.update(c[x-1][y]);if(c[x+1]&&c[x+1][y]&&c[x+1][y].type=='road')this.update(c[x+1][y]);if(c[x][y-1]&&c[x][y-1].type=='road')this.update(c[x][y-1]);if(c[x][y+1]&&c[x][y+1].type=='road')this.update(c[x][y+1])};F.road.update=function(a){var b=a.game.s;var x=a.x,y=a.y;var c='gameObj';if(b[x-1]&&b[x-1][y]&&b[x-1][y].type=='road')c+=' connWest';if(b[x+1]&&b[x+1][y]&&b[x+1][y].type=='road')c+=' connEast';if(b[x][y-1]&&b[x][y-1].type=='road')c+=' connNorth';if(b[x][y+1]&&b[x][y+1].type=='road')c+=' connSouth';if(c=='gameObj')c='gameObj noConn';a.visibleEl.firstChild.className=c};F.resid.add=function(a){a.type='resid'};F.country.add=function(a){a.type='country'};F.industry.add=function(a){a.type='industry'};F.commerce.add=function(a){a.type='commerce'};F.farm.add=function(a){a.type='farm';makeEl('div',{class:'gameObj piece fence1',p:a.visibleEl});makeEl('div',{class:'gameObj piece fence2',p:a.visibleEl});makeEl('div',{class:'gameObj piece fence3',p:a.visibleEl});makeEl('div',{class:'gameObj piece fence4',p:a.visibleEl})};F.silo.add=function(a){a.type='silo';makeEl('div',{class:'gameObj piece p1',p:a.visibleEl,t:'<div class="piece p2"></div>'})};addBaseBuilding=function(a,b){a.type=b;var c=makeEl('div',{class:'gameObj building',p:a.visibleEl});return{base:c,face1:makeEl('div',{class:'piece face1',p:c}),face2:makeEl('div',{class:'piece face2',p:c}),top:makeEl('div',{class:'piece top',p:c})}};F.factory.add=function(a){addBaseBuilding(a,'factory').top.innerHTML='<div class="piece chimney"></div><div class="smoke">...</div>'};F.house.add=function(a){a.dwellers=0;addBaseBuilding(a,'house').top.innerHTML='<div class="roof1"></div><div class="roof2"></div>'};F.shopping.add=function(a){addBaseBuilding(a,'shopping').top.innerHTML='$'};F.hospital.add=function(a){addBaseBuilding(a,'hospital').top.innerHTML='✚'};F.police.add=function(a){addBaseBuilding(a,'police').top.innerHTML='★'};F.school.add=function(a){addBaseBuilding(a,'school').top.innerHTML='<span>School</span>'};F.powerCoal.add=function(a){var b=addBaseBuilding(a,'powerCoal');b.top.innerHTML='<div class="piece chimney"></div><div class="smoke">...</div>';b.face1.innerHTML='⌁';b.face2.innerHTML='⌁'};F.powerWind.add=function(a){a.type='powerWind';var b=makeEl('div',{class:'gameObj building piece basis',p:a.visibleEl});var c=makeEl('div',{class:'helixGroup',p:b});makeEl('div',{class:'piece helix1',p:c});makeEl('div',{class:'piece helix2',p:c});makeEl('div',{class:'piece helix3',p:c})};F.sport.add=function(a){a.type='sport';makeEl('div',{class:'gameObj piece',p:a.visibleEl})}})(this);
